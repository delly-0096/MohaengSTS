<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.mypage.notifications.mapper.INotiAlarmMapper">


<select id="selectAlarmCount"
        parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO"
        resultType="int">
  SELECT COUNT(*)
  FROM ALARM
  WHERE MEM_NO = #{memNo}
  <if test="searchType != null and searchType != '' and searchType != 'ALL'">
    <choose>
      <when test="searchType == 'PAYMENT'">
        AND ALARM_TYPE IN ('PAYMENT')
      </when>
      <when test="searchType == 'POINT'">
        AND ALARM_TYPE IN ('POINT')
      </when>
      <when test="searchType == 'INQUIRY'">
        AND ALARM_TYPE IN ('INQUIRY','PROD_INQUIRY')
      </when>
      <when test="searchType == 'SYSTEM'">
        AND ALARM_TYPE IN ('SYSTEM')
      </when>
    </choose>
  </if>
</select>


  <select id="selectAlarmList"
        parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO"
        resultType="kr.or.ddit.mohaeng.vo.AlarmVO">
  <![CDATA[
  SELECT *
  FROM (
    SELECT t.*, ROWNUM rn
    FROM (
      SELECT
        ALARM_NO, MEM_NO, SENDER, ALARM_TYPE, ALARM_CONT, MOVE_URL,
        READ_YN, READ_DT, to_char(reg_dt, 'yyyy-mm-dd hh24:mi:ss') reg_dt
      FROM ALARM
      WHERE MEM_NO = #{memNo}
  ]]>
      <if test="searchType != null and searchType != '' and searchType != 'ALL'">
        <choose>
          <when test="searchType == 'PAYMENT'">
            AND ALARM_TYPE IN ('PAYMENT')
          </when>
          <when test="searchType == 'POINT'">
            AND ALARM_TYPE IN ('POINT')
          </when>
          <when test="searchType == 'INQUIRY'">
            AND ALARM_TYPE IN ('INQUIRY','PROD_INQUIRY')
          </when>
          <when test="searchType == 'SYSTEM'">
            AND ALARM_TYPE IN ('SYSTEM')
          </when>
        </choose>
      </if>
  <![CDATA[
      ORDER BY REG_DT DESC
    ) t
    WHERE ROWNUM <= #{endRow}
  )
  WHERE rn >= #{startRow}
  ]]>
</select>

  
  <select id="selectAlramList" parameterType="int" resultType="kr.or.ddit.mohaeng.vo.AlarmVO">
  	select 
  		alarm_no, mem_no, sender, alarm_type, alarm_cont, move_url, read_yn, read_dt, to_char(reg_dt, 'yyyy-mm-dd hh24:mi:ss') reg_dt
  	from alarm
	where mem_no = #{memNo}
	and read_yn = 'N'
  </select>
  
  <!-- 안읽은 알림 개수 -->
<!-- <select id="selectUnreadCount" parameterType="int" resultType="int">
  SELECT COUNT(*)
  FROM ALARM
  WHERE MEM_NO = #{memNo}
    AND READ_YN = 'N'
</select> -->

<!-- 알림 1건 읽음 처리 -->
<update id="updateReadOne" parameterType="map">
  UPDATE ALARM
  SET READ_YN = 'Y',
      READ_DT = SYSDATE
  WHERE ALARM_NO = #{alarmNo}
    AND MEM_NO = #{memNo}
    AND READ_YN = 'N'
</update>

<!-- 알림 등록 -->
<insert id="insertAlarm"
        parameterType="kr.or.ddit.mohaeng.vo.AlarmVO">
  INSERT INTO ALARM (
    ALARM_NO,
    MEM_NO,
    SENDER,
    ALARM_TYPE,
    ALARM_CONT,
    MOVE_URL,
    READ_YN,
    REG_DT
  ) VALUES (
    SEQ_ALARM.NEXTVAL,
    #{memNo},
    #{sender},
    #{alarmType},
    #{alarmCont},
    #{moveUrl},
    'N',
    SYSDATE
  )
</insert>

<update id="updateAllRead" parameterType="int">
  UPDATE ALARM
	SET READ_YN = 'Y',
  	  READ_DT = SYSDATE
	WHERE MEM_NO =  #{memNo}
 	 AND NVL(UPPER(READ_YN), 'N') = 'N'

</update>
 <select id="selectUnreadCount" parameterType="int" resultType="int">
SELECT COUNT(*)
FROM ALARM
WHERE MEM_NO =  #{memNo}
  AND NVL(UPPER(READ_YN), 'N') = 'N'
</select>

<update id="updateReadSelected" parameterType="map">
  UPDATE ALARM
  SET READ_YN = 'Y', READ_DT = SYSDATE
  WHERE MEM_NO = #{memNo}
    AND ALARM_NO IN
    <foreach collection="alarmNos" item="no" open="(" separator="," close=")">
      #{no}
    </foreach>
</update>

<delete id="deleteSelected" parameterType="map">
  DELETE FROM ALARM
  WHERE MEM_NO = #{memNo}
    AND ALARM_NO IN
    <foreach collection="alarmNos" item="no" open="(" separator="," close=")">
      #{no}
    </foreach>
</delete>


</mapper>
