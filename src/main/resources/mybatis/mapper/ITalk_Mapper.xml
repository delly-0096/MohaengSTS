<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.community.mapper.ITalkMapper">

  <!-- 검색 조건 (공지처럼) -->
  <sql id="searchBoard">
    <if test="searchWord != null and searchWord != ''">
      AND (BOARD_TITLE LIKE '%'||#{searchWord}||'%' OR BOARD_CONTENT LIKE '%'||#{searchWord}||'%')
    </if>
    <if test="searchType != null and searchType != 'all'">
      AND BOARD_CTGRY_CD = #{searchType}
    </if>
    <!-- 기본: 삭제글 제외 -->
    AND DEL_YN = 'N'
  </sql>

  <!-- Board + 파일조인 결과 매핑 -->
  <resultMap id="boardMap" type="kr.or.ddit.mohaeng.vo.BoardVO">
    <id property="boardNo" column="BOARD_NO"/>

    <result property="boardCtgryCd" column="BOARD_CTGRY_CD"/>
    <result property="writerNo" column="WRITER_NO"/>
    <result property="attachNo" column="ATTACH_NO"/>

    <result property="boardTitle" column="BOARD_TITLE"/>
    <result property="boardContent" column="BOARD_CONTENT"/>

    <result property="viewCnt" column="VIEW_CNT"/>
    <result property="likeCnt" column="LIKE_CNT"/>

    <result property="noticeYn" column="NOTICE_YN"/>
    <result property="pinYn" column="PIN_YN"/>

    <result property="delYn" column="DEL_YN"/>
    <result property="delDt" column="DEL_DT"/>

    <result property="regDt" column="REG_DT"/>
    <result property="modDt" column="MOD_DT"/>
    
    <result property="writerNickname" column="WRITER_NICKNAME"/>
	<result property="writerId" column="WRITER_ID"/>
    <result property="commentCnt" column="COMMENT_CNT"/>
    
    <result property="likes" column="likes_key"/>

    <!-- 첨부파일 리스트 -->
    <collection property="boardFileList" resultMap="attachFileDetailMap"/>
    <!-- 해시태그 리스트 -->
    <collection property="boardTagList"  ofType="string" column="BOARD_NO"
              select="selectTalkTags"/>
  </resultMap>

  <resultMap id="attachFileDetailMap" type="kr.or.ddit.mohaeng.vo.BoardFileVO">
    <id property="fileNo" column="FILE_NO"/>

    <result property="fileNo" column="FILE_NO"/>
    <result property="attachNo" column="ATTACH_NO"/>

    <result property="fileName" column="FILE_NAME"/>
    <result property="fileOriginalName" column="FILE_ORIGINAL_NAME"/>
    <result property="fileExt" column="FILE_EXT"/>
    <result property="fileSize" column="FILE_SIZE"/>
    <result property="filePath" column="FILE_PATH"/>
    <result property="fileGbCd" column="FILE_GB_CD"/>
    <result property="mimeType" column="MIMY_TYPE"/>
    <result property="useYn" column="USE_YN"/>
    <result property="regId" column="REG_ID"/>
    <result property="regDt" column="REG_DT"/>
  </resultMap>

	
  <!-- =========================
       1) 상세 조회 (파일 포함)
       ========================= -->
<select id="selectTalk" parameterType="int" resultMap="boardMap">
    SELECT
      b.BOARD_NO, b.BOARD_CTGRY_CD, b.WRITER_NO, b.ATTACH_NO,
      b.BOARD_TITLE, b.BOARD_CONTENT,
      b.VIEW_CNT, b.LIKE_CNT,
      b.NOTICE_YN, b.PIN_YN,
      b.DEL_YN, b.DEL_DT, b.REG_DT, b.MOD_DT,
      (SELECT NICKNAME FROM MEM_USER mu WHERE mu.MEM_NO = b.WRITER_NO) AS WRITER_NICKNAME,
      (SELECT MEM_ID FROM MEMBER m WHERE m.MEM_NO = b.WRITER_NO) AS WRITER_ID,
      (SELECT COUNT(*) FROM COMMENTS c
       WHERE c.TARGET_TYPE = 'TALK'
       AND c.TARGET_NO = b.BOARD_NO
       AND c.CMNT_STATUS = 0
       ) AS COMMENT_CNT,
    
      afd.FILE_NO, afd.FILE_NAME, afd.FILE_ORIGINAL_NAME, afd.FILE_EXT,
      afd.FILE_SIZE, afd.FILE_PATH, afd.FILE_GB_CD, afd.MIMY_TYPE, afd.USE_YN, afd.REG_ID,
      (select likes_key from likes where likes_key = b.board_no and likes_cat_cd = 'talk' and mem_no = WRITER_NO) as likes_key
    FROM BOARD b
      LEFT JOIN ATTACH_FILE af ON (b.ATTACH_NO = af.ATTACH_NO)
      LEFT JOIN ATTACH_FILE_DETAIL afd ON (af.ATTACH_NO = afd.ATTACH_NO AND afd.USE_YN = 'Y')
    WHERE b.BOARD_NO = #{value}
      AND b.DEL_YN = 'N'
  </select>

<!-- 좋아요 여부 확인

  <select id="existsLike" parameterType="map" resultType="int">
  SELECT COUNT(*)
  FROM BOARD_LIKE
  WHERE BOARD_NO = #{boardNo}
    AND MEM_NO   = #{memNo}
</select>
 
 좋아요 추가
  <insert id="insertLike" parameterType="map">
  INSERT INTO BOARD_LIKE (BOARD_NO, MEM_NO)
  VALUES (#{boardNo}, #{memNo})
</insert>
  
  좋아요 삭제
  <delete id="deleteLike" parameterType="map">
  DELETE FROM BOARD_LIKE
  WHERE BOARD_NO = #{boardNo}
    AND MEM_NO   = #{memNo}
</delete>

 좋아요 증감
<update id="increaseLikeCnt" parameterType="int">
  UPDATE BOARD
  SET LIKE_CNT = NVL(LIKE_CNT,0) + 1
  WHERE BOARD_NO = #{boardNo}
</update>

<update id="decreaseLikeCnt" parameterType="int">
  UPDATE BOARD
  SET LIKE_CNT = CASE
    WHEN NVL(LIKE_CNT,0) > 0 THEN LIKE_CNT - 1 ELSE 0 END
  WHERE BOARD_NO = #{boardNo}
</update>

<select id="selectLikeCnt" parameterType="int" resultType="int">
  SELECT NVL(LIKE_CNT,0)
  FROM BOARD
  WHERE BOARD_NO = #{value}
</select>
 -->
  

  <!-- 조회수 증가 -->
  <update id="incrementHit" parameterType="int">
    UPDATE BOARD
    SET VIEW_CNT = NVL(VIEW_CNT, 0) + 1
    WHERE BOARD_NO = #{value}
      AND DEL_YN = 'N'
  </update>

  <!-- =========================
       2) 등록 
       ========================= -->
  <insert id="insertTalk" parameterType="kr.or.ddit.mohaeng.vo.BoardVO" useGeneratedKeys="true">
 	<selectKey keyProperty="boardNo" resultType="int" order="BEFORE">
		select seq_talk.NEXTVAL from dual
	</selectKey>
    INSERT INTO BOARD (
      BOARD_NO,
      BOARD_CTGRY_CD,
      WRITER_NO,
      ATTACH_NO,
      BOARD_TITLE,
      BOARD_CONTENT,
      VIEW_CNT,
      LIKE_CNT,
      NOTICE_YN,
      PIN_YN,
      DEL_YN,
      REG_DT
    ) VALUES (
      #{boardNo},
      #{boardCtgryCd},
      #{writerNo},
      #{attachNo},
      #{boardTitle},
      #{boardContent},
      0,
      0,
      NVL(#{noticeYn}, 'N'),
      NVL(#{pinYn}, 'N'),
      'N',
      SYSDATE
    )
  </insert>

  <!-- =========================
       3) 수정
       ========================= -->
  <update id="updateTalk" parameterType="kr.or.ddit.mohaeng.vo.BoardVO">
    UPDATE BOARD
    SET
      BOARD_CTGRY_CD = #{boardCtgryCd},
      BOARD_TITLE    = #{boardTitle},
      BOARD_CONTENT  = #{boardContent},
      ATTACH_NO      = #{attachNo},
      NOTICE_YN      = NVL(#{noticeYn}, NOTICE_YN),
      PIN_YN         = NVL(#{pinYn}, PIN_YN),
      MOD_DT         = SYSDATE
    WHERE BOARD_NO = #{boardNo}
      AND DEL_YN = 'N'
  </update>

  <!-- =========================
       4) 삭제(소프트)
       ========================= -->
  <update id="deleteTalk" parameterType="int">
    UPDATE BOARD
    SET DEL_YN = 'Y',
        DEL_DT = SYSDATE
    WHERE BOARD_NO = #{value}
      AND DEL_YN = 'N'
  </update>

  <!-- =========================
       5) 목록/페이징 (공지 스타일)
       ========================= -->

  <select id="selectTalkCount" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="int">
    SELECT COUNT(BOARD_NO)
    FROM BOARD
    WHERE 1=1
    <include refid="searchBoard"/>
  </select>
  <select id="selectTalkCommentCount" parameterType="int" resultType="int"> 
		SELECT COUNT(*)
		 FROM COMMENTS
		  WHERE TARGET_TYPE = 'TALK'
		   AND TARGET_NO = #{boardNo}
		   AND CMNT_STATUS = 0
 </select>
 
   <select id="selectTalkList" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="kr.or.ddit.mohaeng.vo.BoardVO" resultMap="boardMap">
    SELECT b.*
    FROM (
      SELECT a.*, ROW_NUMBER() OVER(
        ORDER BY
          CASE WHEN a.PIN_YN = 'Y' THEN 0 ELSE 1 END,
          CASE WHEN a.NOTICE_YN = 'Y' THEN 0 ELSE 1 END,
          a.BOARD_NO DESC
      ) rnum
      FROM (
        SELECT 
        	(SELECT NICKNAME FROM MEM_USER mu WHERE mu.MEM_NO = b.WRITER_NO) AS WRITER_NICKNAME
		  , (SELECT MEM_ID FROM MEMBER m WHERE m.MEM_NO = b.WRITER_NO) AS WRITER_ID
		  , (SELECT COUNT(*)  FROM COMMENTS c
              WHERE c.TARGET_TYPE = 'TALK'
               AND c.TARGET_NO = b.BOARD_NO
               AND c.CMNT_STATUS = 0
             ) AS COMMENT_CNT
          , b.BOARD_NO          
          , b.BOARD_CTGRY_CD  
          , b.WRITER_NO
          , b.ATTACH_NO
          , b.BOARD_TITLE
          , b.BOARD_CONTENT
          , b.VIEW_CNT
          , b.LIKE_CNT
          , b.NOTICE_YN
          , b.PIN_YN
          , b.DEL_YN
          , b.DEL_DT
          , b.REG_DT
          , b.MOD_DT
        FROM BOARD b
        WHERE 1=1
        <include refid="searchBoard"/>
      ) a
    ) b
    <![CDATA[
      WHERE b.rnum >= #{startRow} AND b.rnum <= #{endRow}
    ]]>
  </select>
  
     <!--여행톡 상세페이지 파일 1건 조회 (다운로드/미리보기용) -->
  <select id="getFileInfo" parameterType="int" resultType="kr.or.ddit.mohaeng.vo.BoardFileVO">
    SELECT
        FILE_NO,
        ATTACH_NO,
        FILE_NAME,
        FILE_ORIGINAL_NAME,
        FILE_EXT,
        FILE_SIZE,
        FILE_PATH,
        FILE_GB_CD,
        MIMY_TYPE,
        USE_YN,
        REG_ID,
        REG_DT
    FROM ATTACH_FILE_DETAIL
    WHERE FILE_NO = #{fileNo}
  </select>
    <!--  태그추가 -->
   <select id="selectTalkTags" parameterType="int" resultType="string">
  SELECT BOARD_TAG_NAME
  FROM BOARD_TAG
  WHERE BOARD_NO = #{value}
  ORDER BY BOARD_TAG_NO
</select>
   
  <!-- =========================
       6) 좋아요 증감(임시)
       ========================= -->
  <update id="increaseLike" parameterType="int">
    UPDATE BOARD
    SET LIKE_CNT = NVL(LIKE_CNT,0) + 1
    WHERE BOARD_NO = #{value}
      AND DEL_YN = 'N'
  </update>

  <update id="decreaseLike" parameterType="int">
    UPDATE BOARD
    SET LIKE_CNT = CASE WHEN NVL(LIKE_CNT,0) > 0 THEN LIKE_CNT - 1 ELSE 0 END
    WHERE BOARD_NO = #{value}
      AND DEL_YN = 'N'
  </update>

<!-- 태그 delete -->
 <delete id="deleteTalkTags" parameterType="int">
    DELETE FROM BOARD_TAG 
    WHERE BOARD_NO = #{boardNo}
</delete>

<!-- 태그 insert -->
<insert id="insertTalkTags" parameterType="java.util.List">
    INSERT INTO Board_Tag (
        BOARD_TAG_NO, 
        BOARD_NO, 
        BOARD_TAG_NAME
    )
    SELECT SEQ_TALK_TAG.NEXTVAL, A.* FROM (
        <foreach collection="list" item="t" separator=" UNION ALL ">
            SELECT #{t.boardNo} AS BOARD_NO, 
                   #{t.boardTagName} AS BOARD_TAG_NAME 
            FROM DUAL
        </foreach>
    ) A
</insert>
 
 
	<!-- 2026.01.20 HJ -좋아요 -->
	<select id="selectTalkLike" parameterType="kr.or.ddit.mohaeng.vo.LikesVO" resultType="kr.or.ddit.mohaeng.vo.LikesVO">
		select * from likes
		where likes_key = #{likesKey}
		and mem_no = #{memNo}
		and likes_cat_cd = 'talk'
	</select>
	
	<insert id="insertTalkLike" parameterType="kr.or.ddit.mohaeng.vo.LikesVO">
		insert into likes(
			likes_key, likes_cat_cd, mem_no
		)values(
			#{likesKey}, #{likesCatCd}, #{memNo}
		)
	</insert>
	
	<update id="incrementTalkLikeCnt" parameterType="int">
		update board
		set
			like_cnt = like_cnt + 1
		where board_no = #{likesKey}
	</update>
	 
	<delete id="deleteTalkLike" parameterType="kr.or.ddit.mohaeng.vo.LikesVO">
		delete from likes
		where likes_key = #{likesKey}
		and likes_cat_cd = 'talk'
		and mem_no = #{memNo}
	</delete>
	
	<update id="decrementTalkLikeCnt" parameterType="int">
		update board
		set
			like_cnt = like_cnt - 1
		where board_no = #{likesKey}
	</update>
	<!-- 2026.01.20 HJ -좋아요 End --> 

</mapper>