<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.admin.log.mapper.IAdminLogMapper">

	<!-- 로그목록 카운트 -->
    <select id="getSystemLogCount" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="int">
        SELECT COUNT(*)
        FROM SYSTEM_LOG
    </select>
    
    <!-- 검색은 다시 -->
    <!-- 로그 목록 조회-->
    <select id="getSystemLogList" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="kr.or.ddit.mohaeng.vo.SystemLogVO">
        SELECT *
        FROM (
            SELECT ROWNUM AS rn, a.*
            FROM (
                SELECT
	                SYSTEM_LOG_NO
					, "LEVEL"
					, SOURCE
					, MSG
					, IP
					, REG_DT
					, SYSTEM_LOG_MEM
                FROM SYSTEM_LOG
<!--                 <where> -->
<!--                 <if test="keyword != null and keyword != ''"> -->
<!--                     AND ( -->
<!--                         source LIKE '%' || #{keyword} || '%' -->
<!--                         OR msg LIKE '%' || #{keyword} || '%' -->
<!--                         OR system_log_mem LIKE '%' || #{keyword} || '%' -->
<!--                     ) -->
<!--                 </if> -->
<!--                 </where> -->
                ORDER BY REG_DT DESC, SYSTEM_LOG_NO DESC
            ) a
            <![CDATA[
            WHERE ROWNUM <= #{currentPage} * #{screenSize}
            ]]>
        )
        <![CDATA[
        WHERE rn > (#{currentPage} - 1) * #{screenSize}
        ]]>
    </select>
    
    
    <!-- 전체 개수, 그런거 알아오기 -->
    <select id="getSystemLogStats" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="map">
    SELECT 
	        COUNT(*) AS TOTAL,
	        COUNT(CASE WHEN SOURCE LIKE '%Talk%' OR SOURCE LIKE '%Comment%' THEN 1 END) AS COMMUNITY,
	        COUNT(CASE WHEN SOURCE LIKE '%Chat%' THEN 1 END) AS CHAT,
	        COUNT(CASE WHEN SOURCE LIKE '%Login%' THEN 1 END) AS AUTH,
	        COUNT(CASE WHEN SOURCE LIKE '%Accommodation%' THEN 1 END) AS PRODUCT,
	        
	        COUNT(CASE WHEN "LEVEL" = 'INFO' THEN 1 END) AS LEVEL_INFO,
	        COUNT(CASE WHEN "LEVEL" = 'WARN' THEN 1 END) AS LEVEL_WARN,
	        COUNT(CASE WHEN "LEVEL" = 'ERROR' THEN 1 END) AS LEVEL_ERROR
	    FROM SYSTEM_LOG
	    WHERE REG_DT BETWEEN TO_DATE(#{searchVO.startDate} || ' 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                     AND TO_DATE(#{searchVO.endDate} || ' 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
	</select>
    
</mapper>