<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.admin.transactions.payments.mapper.IAdminPaymentsMapper">

    <select id="selectAdminPaymentStats" resultType="map">
        SELECT 
            COUNT(*) AS TOTAL_COUNT,
            COUNT(CASE WHEN PAY_STATUS != 'CANCEL' AND 
                NVL((SELECT MIN(RESV_DT) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO),
                    (SELECT MIN(FP.DEP_TIME) FROM FLIGHT_RESERVATION FR JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID WHERE FR.PAY_NO = P.PAY_NO)
                ) <![CDATA[ < ]]> TRUNC(SYSDATE) THEN 1 END) AS COMPLETED_COUNT,
            COUNT(CASE WHEN PAY_STATUS != 'CANCEL' AND 
                NVL((SELECT MIN(RESV_DT) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO),
                    (SELECT MIN(FP.DEP_TIME) FROM FLIGHT_RESERVATION FR JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID WHERE FR.PAY_NO = P.PAY_NO)
                ) >= TRUNC(SYSDATE) THEN 1 END) AS PENDING_COUNT,
            NVL(SUM(CASE WHEN PAY_STATUS != 'CANCEL' THEN PAY_TOTAL_AMT ELSE 0 END), 0) AS TOTAL_REVENUE
        FROM PAYMENT P
    </select>

    <select id="selectAdminPaymentsCount" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="int">
        SELECT COUNT(*) 
        FROM PAYMENT P
        JOIN MEMBER M ON P.MEM_NO = M.MEM_NO
        JOIN PAYMENT_INFO PI ON P.PAY_NO = PI.PAY_NO
        <where>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(searchWord)">
                AND (
                    M.MEM_NAME LIKE '%' || #{searchWord} || '%' OR 
                    PI.RES_MSG LIKE '%' || #{searchWord} || '%' OR
                    (TO_CHAR(P.PAY_DT, 'YYYYMMDD') || LPAD(P.PAY_NO, 8, '0')) LIKE '%' || #{searchWord} || '%'
                )
            </if>
        </where>
    </select>

    <select id="selectAdminPaymentsList" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="kr.or.ddit.mohaeng.vo.AdminPaymentsVO">
	    SELECT B.* FROM (
	        SELECT A.*, ROWNUM RNUM FROM (
	            SELECT 
	                P.PAY_NO AS payNo, 
	                TO_CHAR(P.PAY_DT, 'YYYYMMDD') || LPAD(P.PAY_NO, 8, '0') AS orderNo,
	                P.PAY_DT AS payDt,
	                P.PAY_TOTAL_AMT AS payTotalAmt,
	                P.USE_POINT AS usePoint,
	                P.PAY_METHOD_CD AS payMethodCd,
	                P.PAY_STATUS AS payStatus,
	                M.MEM_NAME AS memName,
	                M.MEM_EMAIL AS memEmail,
	                MU.TEL AS memTel,
	                REPLACE(PI.RES_MSG, 'DONE ', '') AS prodName,
	                C.BZMN_NM AS bzmnNm,
	                C.BRNO AS brno,
	                C.COMP_TEL AS compTel,
	                NVL((SELECT AFD.FILE_PATH FROM ATTACH_FILE_DETAIL AFD 
	                     JOIN TRIP_PROD TP_I ON TP_I.ATTACH_NO = AFD.ATTACH_NO 
	                     JOIN TRIP_PROD_LIST TPL_I ON TPL_I.TRIP_PROD_NO = TP_I.TRIP_PROD_NO 
	                     WHERE TPL_I.PAY_NO = P.PAY_NO AND ROWNUM = 1), '/resources/images/default_flight.jpg') AS thumbImg,
	                NVL((SELECT TO_CHAR(MIN(RESV_DT), 'YYYY.MM.DD') || ' | ' || SUM(QUANTITY) || '명' FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO), '항공권 정보') AS useDateInfo
	            FROM PAYMENT P
	            JOIN MEMBER M ON P.MEM_NO = M.MEM_NO
	            LEFT OUTER JOIN MEM_USER MU ON M.MEM_NO = MU.MEM_NO
	            JOIN PAYMENT_INFO PI ON P.PAY_NO = PI.PAY_NO
	            LEFT OUTER JOIN (SELECT PAY_NO, TRIP_PROD_NO, ROW_NUMBER() OVER(PARTITION BY PAY_NO ORDER BY PROD_LIST_NO) AS RN FROM TRIP_PROD_LIST) TPL ON P.PAY_NO = TPL.PAY_NO AND TPL.RN = 1
	            LEFT OUTER JOIN TRIP_PROD TP ON TPL.TRIP_PROD_NO = TP.TRIP_PROD_NO
	            LEFT OUTER JOIN COMPANY C ON TP.COMP_NO = C.COMP_NO
	            <where>
	                <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(searchWord)">
	                    AND (M.MEM_NAME LIKE '%' || #{searchWord} || '%' OR PI.RES_MSG LIKE '%' || #{searchWord} || '%')
	                </if>
	            </where>
	            ORDER BY P.PAY_DT DESC
	        ) A
	    ) B
	    WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	</select>

</mapper>