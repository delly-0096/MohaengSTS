<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ddit.mohaeng.community.travellog.bookmark.mapper.IBookmarkMapper">

  <!-- 단건 조회 (상태 확인) -->
  <select id="selectOneByUserAndTarget" resultType="kr.or.ddit.mohaeng.vo.BookmarkVO">
    SELECT
      BMK_NO     AS bmkNo,
      BMK_TYPE   AS bmkType,
      MEM_NO     AS memNo,
      PRDT_NO    AS prdtNo,
      REG_DT     AS regDt,
      DEL_YN     AS delYn,
      DEL_DT     AS delDt
    FROM BOOKMARK
    WHERE MEM_NO = #{memNo}
      AND BMK_TYPE = #{bmkType}
      AND PRDT_NO = #{prdtNo}
  </select>

  <!-- 신규 등록: SEQ_BOOKMARK 사용 -->
  <insert id="insertBookmark">
    INSERT INTO BOOKMARK (
      BMK_NO, BMK_TYPE, MEM_NO, PRDT_NO, REG_DT, DEL_YN, DEL_DT
    ) VALUES (
      SEQ_BOOKMARK.NEXTVAL,
      #{bmkType},
      #{memNo},
      #{prdtNo},
      SYSDATE,
      'N',
      NULL
    )
  </insert>

  <!-- 복구 -->
  <update id="restoreBookmark">
    UPDATE BOOKMARK
       SET DEL_YN = 'N',
           DEL_DT = NULL,
           REG_DT = SYSDATE
     WHERE BMK_NO = #{bmkNo}
  </update>

  <!-- 소프트 삭제 -->
  <update id="softDeleteBookmark">
    UPDATE BOOKMARK
       SET DEL_YN = 'Y',
           DEL_DT = SYSDATE
     WHERE BMK_NO = #{bmkNo}
  </update>

  <!-- 대상별 카운트 -->
  <select id="countByTarget" resultType="int">
    SELECT COUNT(*)
      FROM BOOKMARK
     WHERE BMK_TYPE = #{bmkType}
       AND PRDT_NO = #{prdtNo}
       AND DEL_YN = 'N'
  </select>

  <!-- 내 북마크 total -->
  <select id="countMyBookmarks" resultType="int">
    SELECT COUNT(*)
      FROM BOOKMARK
     WHERE MEM_NO = #{memNo}
       AND BMK_TYPE = #{bmkType}
       AND DEL_YN = 'N'
  </select>

  <!-- 내 북마크 목록 (TRIP_RECORD join) -->
  <select id="selectMyBookmarksPaged" resultType="kr.or.ddit.mohaeng.vo.BookmarkMyListItemVO">
    SELECT
      tr.RCD_NO       AS rcdNo,
      tr.RCD_TITLE    AS rcdTitle,
      tr.MEM_NO       AS writerMemNo,
      m.MEM_NAME      AS writerName,
      tr.REG_DT       AS regDt,

      /* 원하면 같이 보여줄 카운트(이미 1번에서 구현했으면 빼도 됨) */
      (SELECT COUNT(*)
         FROM BOOKMARK b
        WHERE b.BMK_TYPE = 'TRIP_RECORD'
          AND b.PRDT_NO = tr.RCD_NO
          AND b.DEL_YN = 'N'
      ) AS bookmarkCount

    FROM BOOKMARK bmk
    JOIN TRIP_RECORD tr
      ON tr.RCD_NO = bmk.PRDT_NO
    LEFT JOIN MEMBER m
      ON m.MEM_NO = tr.MEM_NO
    WHERE bmk.MEM_NO = #{memNo}
      AND bmk.BMK_TYPE = #{bmkType}
      AND bmk.DEL_YN = 'N'
    ORDER BY bmk.REG_DT DESC
    OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
  </select>

</mapper>
