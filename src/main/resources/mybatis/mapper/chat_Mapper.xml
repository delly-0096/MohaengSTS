<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.community.chat.mapper.IChatMapper">

	<!-- ì±„íŒ…ë°© ìƒì„± -->
	<insert id="insertChatRoom" parameterType="kr.or.ddit.mohaeng.vo.ChatRoomVO">
	    <selectKey keyProperty="chatId" resultType="int" order="BEFORE">
        SELECT SEQ_CHAT_ROOM.NEXTVAL FROM DUAL
    	</selectKey>
		INSERT INTO CHAT_ROOM (
				  CHAT_ID
				  , CHAT_NAME
				  , CHAT_CTGRY
				  , CHAT_MAX
				  , REG_ID
				  , REG_DT
		) VALUES (
					#{chatId}
				  , #{chatName}
				  , #{chatCtgry}
				  , #{chatMax}
				  , #{regId}
				  , SYSDATE	
		)
	</insert>
	
	<!-- ì±„íŒ…ë°© ìœ ì € ì‚­ì œ -->
	<delete id="deleteAllChatUsersByRoomId">
	    DELETE FROM CHAT_USER
	    WHERE CHAT_ID = #{chatId}
	</delete>
	
	<!-- ì±„íŒ…ë°© ë©”ì‹œì§€ ì‚­ì œ -->
	<update id="deleteAllChatMessagesByRoomId">
	    UPDATE CHAT
	    SET CHAT_DEL = 'Y'
	    WHERE CHAT_ID = #{chatId}
	</update>
	
	<!-- HOST í‡´ìž¥ ì‹œ ì±„íŒ…ë°© ì‚­ì œ -->
	<delete id="deleteChatRoomPermanently">
	    DELETE FROM CHAT_ROOM
	    WHERE CHAT_ID = #{chatId}
	</delete>
		
	<!-- ì±„íŒ…ë°© HOST ìƒì„± -->
	<insert id="insertChatHost" parameterType="kr.or.ddit.mohaeng.vo.ChatUserVO">
		INSERT INTO CHAT_USER (
				  CHAT_ID
				  , CHAT_USER_NO
				  , JOINED_AT
				  , CHAT_ROLE
				  , CHAT_STATUS
		) VALUES (
				 #{chatId}
				  , #{chatUserNo}
				  , SYSDATE
				  , 'HOST'
				  , 'ONLINE'
		)
	</insert>

	<!-- ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ -->
	<select id="selectChatRooms">
		SELECT
            R.CHAT_ID        AS chatId
          , R.CHAT_NAME      AS chatName
          , R.CHAT_CTGRY     AS chatCtgry
          , C.CD_NAME        AS chatCtgryName
          , R.CHAT_MAX       AS chatMax
          , NVL(CNT.USER_CNT, 0) AS currentUsers
          , R.REG_ID         AS createdById
          , U.NICKNAME       AS createdByNickname
          /* ðŸ’¡ ì•ˆ ì½ì€ ë©”ì‹œì§€ ê°œìˆ˜ (ë¡œê·¸ì¸í•œ memId ê¸°ì¤€) */
          , (SELECT COUNT(*) 
             FROM CHAT Msg 
             WHERE Msg.CHAT_ID = R.CHAT_ID 
               AND Msg.CHAT_DEL = 'N'
               AND Msg.CHAT_TYPE = 'CHAT'
               AND Msg.CHAT_NO > (SELECT NVL(CU.LAST_MSG_ID, 0) 
                                  FROM CHAT_USER CU 
                                  WHERE CU.CHAT_ID = R.CHAT_ID 
                                    AND CU.CHAT_USER_NO = (SELECT MEM_NO FROM MEMBER WHERE MEM_ID = #{memId}))
            ) AS "unreadCount"
        FROM CHAT_ROOM R
        LEFT JOIN CODE C ON R.CHAT_CTGRY = C.CD AND C.CDGR = 'CHAT_CATEGORY'
        LEFT JOIN (
            SELECT CHAT_ID, COUNT(*) AS USER_CNT
            FROM CHAT_USER
            GROUP BY CHAT_ID
        ) CNT ON R.CHAT_ID = CNT.CHAT_ID
        LEFT JOIN MEMBER M ON R.REG_ID = M.MEM_ID
        LEFT JOIN MEM_USER U ON M.MEM_NO = U.MEM_NO
    <where>
        <if test="category != null and category != ''">
            R.CHAT_CTGRY = #{category}
        </if>
    </where> 
    ORDER BY R.REG_DT DESC
	</select>
	
	<!--  ì±„íŒ…ë°© ì¤‘ë³µ ìž…ìž¥ ì²´í¬ -->
	<select id="existsChatUser">
		SELECT COUNT(*)
		FROM CHAT_USER
		WHERE CHAT_ID = #{chatId}
		  AND CHAT_USER_NO = #{memNo}
	</select>
	
	<!-- ì±„íŒ…ë°© ìž…ìž¥ ì‹œ í˜„ìž¬ ì¸ì› ìˆ˜ ì²´í¬ -->
	<select id="countChatUsers">
		SELECT COUNT(*)
		FROM CHAT_USER
		WHERE CHAT_ID = #{chatId}
	</select>
	
	<!--  ì±„íŒ…ë°© ìž…ìž¥ ì‹œ ìµœëŒ€ ì¸ì› ìˆ˜ ì²´í¬ -->
	<select id="selectChatMax">
		SELECT CHAT_MAX
		FROM CHAT_ROOM
		WHERE CHAT_ID = #{chatId}
	</select>
	
	<!--  ì±„íŒ…ë°© ìž…ìž¥ ì‹œ merge -->
	<insert id="insertChatUser">
		MERGE INTO CHAT_USER CU
		USING DUAL
		ON (
			CU.CHAT_ID = #{chatId}
			AND CU.CHAT_USER_NO = #{memNo}
		)
		WHEN MATCHED THEN
			UPDATE SET
			CHAT_STATUS = 'ONLINE'
			, JOINED_AT = SYSDATE
		WHEN NOT MATCHED THEN
			INSERT (
				CHAT_ID
				, CHAT_USER_NO
				, JOINED_AT
				, CHAT_ROLE
				, CHAT_STATUS
			) VALUES (
				#{chatId}
				, #{memNo}
				, SYSDATE
				, 'GUEST'
				, 'ONLINE'
			)
			
	</insert>
	
	<!-- WebSocket ëŠê¸¸ ë•Œ update -->
	<update id="disconnectChatUser">
		UPDATE CHAT_USER
		SET CHAT_STATUS = 'OFFLINE'
		WHERE CHAT_ID = #{chatId} 
		AND CHAT_USER_NO = #{memNo}
	</update>
	
	<!-- ì±„íŒ…ë°© í‡´ìž¥ -->
	<delete id="exitChatUser">
	    DELETE FROM CHAT_USER
	    WHERE CHAT_ID = #{chatId}
	      AND CHAT_USER_NO = #{memNo}
	</delete>
	
	<!-- ì±„íŒ…ë°© ì •ë³´ ê°€ì ¸ì˜¤ê¸° -->
	<select id="getChatRoomById" parameterType="long" resultType="kr.or.ddit.mohaeng.vo.ChatRoomVO">
		SELECT
			R.CHAT_ID
		  , R.CHAT_NAME
		  , R.REG_ID
		  , R.CHAT_CTGRY
		  , C. CD_NAME	AS chat_ctgry_name
		  , R.CHAT_MAX
		  , (SELECT COUNT(*) FROM CHAT_USER WHERE CHAT_ID = R.CHAT_ID) AS currentUsers
		FROM CHAT_ROOM R
		LEFT JOIN CODE C ON R.CHAT_CTGRY = C.CD AND C.CDGR = 'CHAT_CATEGORY'
		WHERE R.CHAT_ID = #{chatId}
	</select>
	
	<!-- ì±„íŒ…ë°© ë‚´ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸° -->
	<select id="getChatUsersByRoomId" parameterType="long" resultType="kr.or.ddit.mohaeng.vo.ChatUserVO">
		SELECT
			U.MEM_ID   AS memId
		  , M.NICKNAME AS memName
		 FROM CHAT_USER CU
		 JOIN MEMBER U ON CU.CHAT_USER_NO = U.MEM_NO
		 JOIN MEM_USER M ON U.MEM_NO = M.MEM_NO
		 WHERE CU.CHAT_ID = #{chatId}
		  AND  CU.CHAT_STATUS != 'EXIT'
	</select>
	
	<!-- ì±„íŒ… ë©”ì‹œì§€ insert -->
	<insert id="insertMessage" parameterType="kr.or.ddit.mohaeng.community.chat.dto.ChatMessageDTO">
    INSERT INTO CHAT (
        CHAT_NO
        , CHAT_ID
        , CHAT_DESC
        , CHAT_SENDER_ID
        , CHAT_SENDTIME
        , CHAT_TYPE
        , CHAT_DEL
    ) VALUES (
        SEQ_CHAT_MSG.NEXTVAL
        , #{chatId}
		, #{message}
        , #{memId}
        , SYSDATE
        , #{type}
        , 'N'
    )
	</insert>
	
	<!-- ì±„íŒ…ë°© ê³¼ê±° ë©”ì‹œì§€ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸° -->
	<select id="getChatMessageByRoomId" resultType="kr.or.ddit.mohaeng.vo.ChatVO">
	SELECT
          A.CHAT_NO
        , A.CHAT_ID
        , A.CHAT_DESC
        , A.CHAT_SENDER_ID
        , A.CHAT_SENDTIME
        , A.CHAT_ATCH
        , A.CHAT_TYPE
        , C.NICKNAME AS memNickname 
    FROM CHAT A
    LEFT OUTER JOIN MEMBER B ON (A.CHAT_SENDER_ID = B.MEM_ID)
    LEFT OUTER JOIN MEM_USER C ON (B.MEM_NO = C.MEM_NO)
    WHERE A.CHAT_ID = #{chatId}
      AND A.CHAT_TYPE = 'CHAT'
      AND A.CHAT_DEL = 'N'
    ORDER BY A.CHAT_SENDTIME ASC
	</select>
	
	<!-- ë§ˆì§€ë§‰ ì±„íŒ… ë©”ì‹œì§€ ID select -->
	<select id="getLatestMsgId" parameterType="long" resultType="int">
		SELECT NVL(MAX(CHAT_NO), 0)
		FROM CHAT
		WHERE CHAT_ID = #{chatId}
	</select>
	
	<!-- ë§ˆì§€ë§‰ ì±„íŒ… ë©”ì‹œì§€ ID update -->
	<update id="updateLastMsgId">
		UPDATE CHAT_USER
		   SET LAST_MSG_ID = #{lastMsgId}
		 WHERE CHAT_ID = #{chatId}
		   AND CHAT_USER_NO = (SELECT MEM_NO FROM MEMBER WHERE MEM_ID = #{memId})
	</update>
	
	<!-- ìµœì‹  ì±„íŒ… ì´ë ¥ update -->
	<update id="updateLastReadMessage">
	    UPDATE CHAT_USER
	    SET LAST_MSG_ID = (
	        SELECT NVL(MAX(CHAT_NO), 0)
	        FROM CHAT
	        WHERE CHAT_ID = #{chatId}
	          AND CHAT_DEL = 'N'
	    )
	    WHERE CHAT_ID = #{chatId}
	      AND CHAT_USER_NO = (SELECT MEM_NO FROM MEMBER WHERE MEM_ID = #{memId})
	</update>
</mapper>