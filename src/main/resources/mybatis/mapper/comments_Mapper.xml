<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ddit.mohaeng.community.travellog.comments.mapper.ICommentsMapper">

  <resultMap id="CommentsMap" type="kr.or.ddit.mohaeng.vo.CommentsVO">
    <id property="cmntNo" column="CMNT_NO"/>
    <result property="targetType" column="TARGET_TYPE"/>
    <result property="targetNo" column="TARGET_NO"/>
    <result property="writerNo" column="WRITER_NO"/>
    <result property="parentCmntNo" column="PARENT_CMNT_NO"/>
    <result property="cmntContent" column="CMNT_CONTENT"/>
    <result property="cmntStatus" column="CMNT_STATUS"/>
    <result property="regDt" column="REG_DT"/>
    <result property="modDt" column="MOD_DT"/>

    <result property="writerId" column="WRITER_ID"/>
    <result property="nickname" column="NICKNAME"/>
    <result property="depth" column="DEPTH"/>
    <result property="likeCount" column="LIKE_COUNT"/>
    <result property="myLiked" column="MY_LIKED"/>
    <result property="isWriter" column="IS_WRITER"/>
    <result property="rootCmntNo" column="ROOT_CMNT_NO"/>
    <result property="profilePath" column="PROFILE_PATH"/>
  </resultMap>

  <!-- 댓글/대댓글 목록 -->
  <select id="selectCommentsByTarget" resultMap="CommentsMap">
	  SELECT
	    c.CMNT_NO,
	    c.TARGET_TYPE,
	    c.TARGET_NO,
	    c.WRITER_NO,
	    c.PARENT_CMNT_NO,
	    CONNECT_BY_ROOT c.CMNT_NO AS ROOT_CMNT_NO,
	    CASE
	      WHEN c.CMNT_STATUS = 1 THEN '삭제된 댓글입니다.'
	      ELSE c.CMNT_CONTENT
	    END AS CMNT_CONTENT,
	    c.CMNT_STATUS,
	    c.REG_DT,
	    c.MOD_DT,
	
	    m.MEM_ID AS WRITER_ID,
	    NVL(mu.NICKNAME, m.MEM_NAME) AS NICKNAME,
	
	    /* ✅ 프로필 경로 */
	    (prof.FILE_PATH || prof.FILE_NAME) AS PROFILE_PATH,
	
	    (LEVEL - 1) AS DEPTH,
	
	    (SELECT COUNT(*)
	       FROM TEAM3_202507F.LIKES l
	      WHERE l.LIKES_KEY = c.CMNT_NO
	        AND l.LIKES_CAT_CD = 'COMMENT'
	    ) AS LIKE_COUNT,
	
	    CASE
	      WHEN #{loginMemberNo} IS NULL THEN 0
	      WHEN EXISTS (
	        SELECT 1
	          FROM TEAM3_202507F.LIKES l
	         WHERE l.LIKES_KEY = c.CMNT_NO
	           AND l.LIKES_CAT_CD = 'COMMENT'
	           AND l.MEM_NO = #{loginMemberNo}
	      ) THEN 1 ELSE 0
	    END AS MY_LIKED,
	
	    CASE
	      WHEN #{loginMemberNo} IS NULL THEN 0
	      WHEN c.WRITER_NO = #{loginMemberNo} THEN 1 ELSE 0
	    END AS IS_WRITER
	
	  FROM TEAM3_202507F.COMMENTS c
	  JOIN TEAM3_202507F.MEMBER m
	    ON m.MEM_NO = c.WRITER_NO
	  LEFT JOIN TEAM3_202507F.MEM_USER mu
	    ON mu.MEM_NO = m.MEM_NO
	
	  /* ✅ 여기 추가: 프로필 파일(대표 1개만) */
	  LEFT JOIN (
	    SELECT t.*
	    FROM (
	      SELECT
	        afd.MEM_NO,
	        afd.FILE_PATH,
	        afd.FILE_NAME,
	        ROW_NUMBER() OVER (
	          PARTITION BY afd.MEM_NO
	          ORDER BY afd.REG_DT DESC NULLS LAST
	        ) AS RN
	      FROM TEAM3_202507F.ATTACH_FILE_DETAIL afd
	      WHERE afd.FILE_GB_CD = 'PROFILE'
	    ) t
	    WHERE t.RN = 1
	  ) prof
	    ON prof.MEM_NO = m.MEM_NO
	
	  WHERE c.TARGET_TYPE = #{targetType}
	    AND c.TARGET_NO = #{targetNo}
	
	  START WITH c.PARENT_CMNT_NO IS NULL
	  CONNECT BY PRIOR c.CMNT_NO = c.PARENT_CMNT_NO
	  ORDER SIBLINGS BY c.REG_DT ASC
	</select>


  <select id="countByTarget" resultType="int">
    SELECT COUNT(*)
    FROM TEAM3_202507F.COMMENTS
    WHERE TARGET_TYPE = #{targetType}
      AND TARGET_NO = #{targetNo}
  </select>

  <!-- 작성 -->
  <insert id="insertComment" parameterType="kr.or.ddit.mohaeng.vo.CommentsVO">
    INSERT INTO TEAM3_202507F.COMMENTS (
      CMNT_NO, TARGET_TYPE, TARGET_NO, WRITER_NO, PARENT_CMNT_NO,
      CMNT_CONTENT, CMNT_STATUS, REG_DT, MOD_DT
    ) VALUES (
      TEAM3_202507F.SEQ_COMMENTS.NEXTVAL,
      #{targetType}, #{targetNo}, #{writerNo}, #{parentCmntNo},
      #{cmntContent}, 0, SYSDATE, NULL
    )
  </insert>

  <!-- 수정(본인만) -->
  <update id="updateCommentContent">
    UPDATE TEAM3_202507F.COMMENTS
    SET CMNT_CONTENT = #{content},
        MOD_DT = SYSDATE
    WHERE CMNT_NO = #{cmntNo}
      AND WRITER_NO = #{writerNo}
      AND CMNT_STATUS = 0
  </update>

  <!-- 삭제(본인만, 소프트 삭제) -->
  <update id="softDeleteComment">
    UPDATE TEAM3_202507F.COMMENTS
    SET CMNT_STATUS = 1,
        MOD_DT = SYSDATE
    WHERE CMNT_NO = #{cmntNo}
      AND WRITER_NO = #{writerNo}
      AND CMNT_STATUS = 0
  </update>


</mapper>
