<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.mypage.dashboard.mapper.ICompanyDashboardMapper">

	<resultMap type="kr.or.ddit.mohaeng.vo.PaymentVO" id="paymentMap">
		<id property="payNo" column="pay_no"/>
		<result property="payNo" column="pay_no"/>
		<result property="memNo" column="mem_no"/>
		<result property="memName" column="payment_mem_name"/>
		<result property="payTotalAmt" column="pay_total_amt"/>
		<result property="payStatus" column="pay_status"/>
		<collection property="tripProdList" resultMap="tripProdListMap"/>
	</resultMap>
	
	<resultMap type="kr.or.ddit.mohaeng.vo.TripProdListVO" id="tripProdListMap">
		<id property="prodListNo" column="prod_list_no"/>
		<result property="prodListNo" column="prod_list_no"/>
		<result property="tripProdName" column="trip_prod_title"/>
	</resultMap>

  <!-- KPI -->
  <select id="selectKpi" resultType="kr.or.ddit.mohaeng.vo.CompanyDashboardVO$Kpi" parameterType="int">
    SELECT
      NVL((
        SELECT SUM(pl.PAY_PRICE)
        FROM TRIP_PROD_LIST pl
        JOIN PAYMENT p ON p.PAY_NO = pl.PAY_NO
        JOIN TRIP_PROD tp ON tp.TRIP_PROD_NO = pl.TRIP_PROD_NO
        WHERE tp.COMP_NO = (SELECT C.COMP_NO FROM COMPANY C WHERE C.MEM_NO = #{memNo})
          AND p.PAY_STATUS = 'DONE'
          AND p.PAY_DT >= TRUNC(SYSDATE, 'MM')
        AND p.PAY_DT &lt; ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)

      ), 0) AS monthlySales,
 
      NVL((
        SELECT COUNT(*)
        FROM TRIP_PROD_LIST pl
        JOIN PAYMENT p ON p.PAY_NO = pl.PAY_NO
        JOIN TRIP_PROD tp ON tp.TRIP_PROD_NO = pl.TRIP_PROD_NO
        WHERE tp.COMP_NO = (SELECT C.COMP_NO FROM COMPANY C WHERE C.MEM_NO = #{memNo})
          AND p.PAY_STATUS = 'DONE'
          AND p.PAY_DT >= TRUNC(SYSDATE, 'MM')
          AND p.PAY_DT &lt; ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
      ), 0) AS monthlyReservations,

      NVL((
        SELECT COUNT(*)
        FROM TRIP_PROD tp
        WHERE tp.COMP_NO = (SELECT C.COMP_NO FROM COMPANY C WHERE C.MEM_NO = #{memNo})
          AND NVL(tp.DEL_YN, 'N') = 'N'
          AND tp.APPROVE_STATUS = '판매중'
          AND tp.SALE_START_DT &lt;= SYSDATE
          AND tp.SALE_END_DT >= SYSDATE
      ), 0) AS sellingProductCount
    FROM DUAL
  </select>
  
  <!-- TOP 상품 (이번달) -->
  <select id="selectTopProducts" resultType="kr.or.ddit.mohaeng.vo.CompanyDashboardVO$TopTripProd">
    <![CDATA[
    SELECT *
    FROM (
      SELECT
        tp.TRIP_PROD_NO AS tripProdNo,
        tp.TRIP_PROD_TITLE AS tripProdTitle,
        tp.APPROVE_STATUS AS approveStatus,
        SUM(pl.PAY_PRICE) AS sales,
        COUNT(*) AS reservationCount
      FROM TRIP_PROD tp
      JOIN TRIP_PROD_LIST pl ON pl.TRIP_PROD_NO = tp.TRIP_PROD_NO
      JOIN PAYMENT p ON p.PAY_NO = pl.PAY_NO
      WHERE tp.COMP_NO = #{compNo}
        AND p.PAY_STATUS = 'DONE'
        AND p.PAY_DT >= TRUNC(SYSDATE, 'MM')
        AND p.PAY_DT < ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
      GROUP BY tp.TRIP_PROD_NO, tp.TRIP_PROD_TITLE, tp.APPROVE_STATUS
      ORDER BY sales DESC, reservationCount DESC
    )
    WHERE ROWNUM <= #{limit}
    ]]>
  </select>

  <!-- 판매중 상품 수 (인터페이스에 있어서 XML에도 반드시 있어야 함) -->
  <select id="selectSellingProductCount" resultType="int">
    SELECT COUNT(*)
    FROM TRIP_PROD tp
    WHERE tp.COMP_NO = #{compNo}
      AND NVL(tp.DEL_YN,'N')='N'
      AND tp.APPROVE_STATUS='판매중'
      <![CDATA[
	      AND tp.SALE_START_DT <= SYSDATE
	      AND tp.SALE_END_DT >= SYSDATE
      ]]>
  </select>
  
  <select id="selectPaymentList" parameterType="int" resultMap="paymentMap">
	select
		p.pay_no, p.mem_no,
		(select mem_name from member m where p.mem_no = m.mem_no) as payment_mem_name,
		pay_total_amt, pay_status,
		trip_prod_title, comp_no, tp.mem_no
	from payment p left outer join trip_prod_list tpl on(p.pay_no = tpl.pay_no)
				   left outer join trip_prod tp on(tpl.trip_prod_no = tp.trip_prod_no)
	where tp.mem_no = #{memNo}
	order by p.pay_no desc
  </select>
  
  <select id="selectMyProductList" resultType="kr.or.ddit.mohaeng.tour.vo.TripProdVO">
	    SELECT 
	        A.TRIP_PROD_NO,
	        A.TRIP_PROD_TITLE as title,
	        A.APPROVE_STATUS,
	        A.PROD_CTGRY_TYPE,
	        A.VIEW_CNT,
	        A.REG_DT,
	        B.PRICE 
	    FROM TRIP_PROD A
	    LEFT OUTER JOIN (
	        SELECT TRIP_PROD_NO, MAX(UNIT_PRICE) KEEP (DENSE_RANK LAST ORDER BY PROD_LIST_NO) AS PRICE
	        FROM TRIP_PROD_LIST
	        GROUP BY TRIP_PROD_NO
	    ) B ON A.TRIP_PROD_NO = B.TRIP_PROD_NO
	    WHERE A.MEM_NO = #{memNo} 
	      AND A.DEL_YN = 'N'      
	    ORDER BY A.REG_DT DESC   
  </select>
  
  <!-- 최근 6개월 매출 차트 -->
  <select id="selectMonthlySalesChart" resultType="map">
    SELECT 
        months.month AS "month",
        NVL(SUM(p.PAY_TOTAL_AMT), 0) AS "total"
    FROM (
        SELECT TO_CHAR(ADD_MONTHS(SYSDATE, -LEVEL + 1), 'YYYY-MM') AS month
        FROM DUAL
        CONNECT BY LEVEL &lt;= 6
    ) months
    LEFT OUTER JOIN PAYMENT p ON TO_CHAR(p.PAY_DT, 'YYYY-MM') = months.month
    LEFT OUTER JOIN TRIP_PROD_LIST tpl ON p.PAY_NO = tpl.PAY_NO
    LEFT OUTER JOIN TRIP_PROD tp ON tpl.TRIP_PROD_NO = tp.TRIP_PROD_NO
    WHERE tp.MEM_NO = #{compNo} OR p.PAY_NO IS NULL
    GROUP BY months.month
    ORDER BY months.month ASC
  </select>
  
  <!-- 상품 카테고리 비중 (파이차트) -->
  <select id="selectCategoryRatio" resultType="map">
    SELECT 
        PROD_CTGRY_TYPE AS "type",
        COUNT(*) AS "cnt"
    FROM TRIP_PROD
    WHERE MEM_NO = #{compNo}
    GROUP BY PROD_CTGRY_TYPE
  </select>
 	
 	<!-- 다가오는 예약 일정 -->
	<select id="selectUpcomingReservations" resultType="map">
	    SELECT * FROM (
	        SELECT 
	            (SELECT MEM_NAME FROM MEMBER m WHERE m.MEM_NO = p.MEM_NO) AS "memName",
	            tp.TRIP_PROD_TITLE AS "prodName",
	            TO_CHAR(tpl.RESV_DT, 'YYYY-MM-DD') AS "resvDate", 
	            tpl.USE_TIME AS "useTime",                      
	            tp.PROD_CTGRY_TYPE AS "type"                     
	        FROM TRIP_PROD_LIST tpl
	        JOIN TRIP_PROD tp ON tpl.TRIP_PROD_NO = tp.TRIP_PROD_NO
	        JOIN PAYMENT p ON tpl.PAY_NO = p.PAY_NO              
	        WHERE tp.MEM_NO = #{compNo}                          
	          AND tpl.RESV_DT >= TRUNC(SYSDATE)                  
	          -- AND p.PAY_STATUS = 'CONFIRMED'                
	        ORDER BY tpl.RESV_DT ASC, tpl.USE_TIME ASC           
	    ) WHERE ROWNUM &lt;= 5
	</select>
	
	<!-- 최근 리뷰 피드 -->
	<select id="selectRecentReviews" resultType="map">
	    SELECT * FROM (
	        SELECT 
	            (SELECT MEM_NAME FROM MEMBER m WHERE m.MEM_NO = rv.MEM_NO) AS "memName", 
	            rv.PROD_REVIEW AS "reviewContent",  
	            rv.RATING AS "reviewStar",         
	            TO_CHAR(rv.PROD_REGDATE, 'YYYY-MM-DD') AS "regDate", 
	            tp.TRIP_PROD_TITLE AS "prodName"   
	        FROM PROD_REVIEW rv
	        JOIN TRIP_PROD tp ON rv.TRIP_PROD_NO = tp.TRIP_PROD_NO
	        WHERE tp.MEM_NO = #{compNo}            
	          AND rv.REVIEW_STATUS = 'ACTIVE'    
	        ORDER BY rv.PROD_REGDATE DESC          
	    ) WHERE ROWNUM &lt;= 5
	</select>
	
	<!-- 오늘 이용 상품 수 -->
	<select id="selectTodayArrivalCount" resultType="int">
	    SELECT 
	        COUNT(*)
	    FROM TRIP_PROD_LIST tpl
	    JOIN TRIP_PROD tp ON tpl.TRIP_PROD_NO = tp.TRIP_PROD_NO
	    JOIN PAYMENT p ON tpl.PAY_NO = p.PAY_NO
	    WHERE tp.MEM_NO = #{compNo}
	      AND TRUNC(tpl.RESV_DT) = TRUNC(SYSDATE) 
	      AND p.CANCEL_DT IS NULL              
	      AND p.PAY_STATUS != 'CANCEL'       
	</select>
	<!-- 페이징쿼리 -->
	<select id="selectPaymentListPaging" parameterType="map" resultMap="paymentMap">
<![CDATA[
WITH pay_base AS (
  SELECT DISTINCT
    p.PAY_NO,
    p.MEM_NO,
    (SELECT m.MEM_NAME FROM MEMBER m WHERE m.MEM_NO = p.MEM_NO) AS payment_mem_name,
    p.PAY_TOTAL_AMT,
    p.PAY_STATUS
  FROM PAYMENT p
  JOIN TRIP_PROD_LIST tpl ON tpl.PAY_NO = p.PAY_NO
  JOIN TRIP_PROD tp ON tp.TRIP_PROD_NO = tpl.TRIP_PROD_NO
  WHERE tp.MEM_NO = #{memNo}
),
pay_page AS (
  SELECT *
  FROM (
    SELECT
      pay_base.*,
      ROW_NUMBER() OVER(ORDER BY PAY_NO DESC) AS rn
    FROM pay_base
  )
  WHERE rn BETWEEN #{startRow} AND #{endRow}
)
SELECT
  pp.PAY_NO,
  pp.MEM_NO,
  pp.payment_mem_name,
  pp.PAY_TOTAL_AMT,
  pp.PAY_STATUS,

  tpl.PROD_LIST_NO,
  tp.TRIP_PROD_TITLE

FROM pay_page pp
LEFT JOIN TRIP_PROD_LIST tpl ON tpl.PAY_NO = pp.PAY_NO
LEFT JOIN TRIP_PROD tp ON tp.TRIP_PROD_NO = tpl.TRIP_PROD_NO
ORDER BY pp.PAY_NO DESC, tpl.PROD_LIST_NO
]]>
</select>

	
	<select id="selectPaymentCount" parameterType="int" resultType="int">
  SELECT COUNT(*)
  FROM (
    SELECT DISTINCT p.PAY_NO
    FROM PAYMENT p
    JOIN TRIP_PROD_LIST tpl ON tpl.PAY_NO = p.PAY_NO
    JOIN TRIP_PROD tp ON tp.TRIP_PROD_NO = tpl.TRIP_PROD_NO
    WHERE tp.MEM_NO = #{memNo}
  )
</select>

	
</mapper>
