<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.admin.inquiry.mapper.IQnaMapper">


	<select id="aInquiryList" resultType="kr.or.ddit.mohaeng.vo.InquiryVO">
		SELECT b.*
		FROM (
			SELECT a.*, ROW_NUMBER() OVER(ORDER BY a.REG_DT DESC) rnum
			FROM (
				SELECT
					i.INQRY_NO
					,i.INQRY_CTGRY_CD
					,i.INQRY_STATUS
					,i.INQRY_TITLE
					,i.INQRY_EMAIL
					,i.REG_DT
					,i.DEL_YN
					,c.CD_NAME     AS categoryName
					,m.MEM_NAME    AS memberName
					,m.MEM_ID      AS memId
				FROM INQUIRY i
				LEFT JOIN CODE c
					   ON i.INQRY_CTGRY_CD = c.CD
					  AND c.CDGR = 'INQRY_CAT'
					  AND c.USE_YN = 'Y'
				LEFT JOIN MEMBER m
					   ON i.MEM_NO = m.MEM_NO
				WHERE i.DEL_YN = 'N'

				<!-- 키워드 검색 -->
				<if test="paging.searchWord != null and paging.searchWord != ''">
					AND (
						i.INQRY_TITLE LIKE '%' || #{paging.searchWord} || '%'
						OR m.MEM_NAME    LIKE '%' || #{paging.searchWord} || '%'
						OR m.MEM_ID      LIKE '%' || #{paging.searchWord} || '%'
						OR i.INQRY_EMAIL LIKE '%' || #{paging.searchWord} || '%'
					)
				</if>

				<!-- 상태 필터 -->
				<if test="inquiry.inqryStatus != null and inquiry.inqryStatus != 'all'">
					AND i.INQRY_STATUS = #{inquiry.inqryStatus}
				</if>

				<!-- 카테고리 필터 -->
				<if test="inquiry.inqryCtgryCd != null and inquiry.inqryCtgryCd != 'all'">
					AND i.INQRY_CTGRY_CD = #{inquiry.inqryCtgryCd}
				</if>
			) a
		) b
		<![CDATA[
			WHERE b.rnum >= #{paging.startRow} AND b.rnum <= #{paging.endRow}
		]]>
	</select>

	<!--관리자 문의 총 개수 조회 (목록용 카운트)  -->
	<select id="aInquiryCount" resultType="int">
		select
			count(*)
		from INQUIRY i
		LEFT JOIN MEMBER m
			   ON i.MEM_NO=m.MEM_NO
		where i.DEL_YN = 'N'
		<!--키워드 검색 -->
		<if test="paging.searchWord != null and paging.searchWord != ''">
			 AND (
	               i.INQRY_TITLE LIKE '%' || #{paging.searchWord} || '%'
	            OR m.MEM_NAME    LIKE '%' || #{paging.searchWord} || '%'
	            OR m.MEM_ID      LIKE '%' || #{paging.searchWord} || '%'
	            OR i.INQRY_EMAIL LIKE '%' || #{paging.searchWord} || '%'
	        )
		</if>

		<!--상태 필터 -->
		<if test="inquiry.inqryStatus != null and inquiry.inqryStatus != 'all'">
			AND i.INQRY_STATUS = #{inquiry.inqryStatus}
		</if>

		<!--카테고리 필터  -->
		<if test="inquiry.inqryCtgryCd != null and inquiry.inqryCtgryCd != 'all'">
			AND i.INQRY_CTGRY_CD = #{inquiry.inqryCtgryCd}
		</if>
	</select>

	<!--관리자 문의 상세 조회 -->
	<select id="aInquiryDetail" parameterType="int" resultType="kr.or.ddit.mohaeng.vo.InquiryVO">
		select
			i.INQRY_NO
	        ,i.INQRY_CTGRY_CD
	        ,i.MEM_NO
	        ,i.INQRY_STATUS
	        ,i.INQRY_TITLE
	        ,i.INQRY_CN
	        ,i.INQUIRY_TARGET_NO
	        ,i.INQRY_EMAIL
	        ,i.ATTACH_NO
	        ,i.REG_DT
	        ,i.MOD_DT
	        ,i.DEL_YN
	        ,i.DEL_DT
	        ,i.REPLY_CN
	        ,i.REPLY_MEM_NO
	        ,i.REPLY_DT
	        ,i.REPLY_MOD_DT
	        ,c.CD_NAME     AS categoryName
	        ,m.MEM_NAME    AS memberName
	        ,m.MEM_ID	   AS memId
		from INQUIRY i
		left join CODE c
		 		ON i.INQRY_CTGRY_CD = c.CD
		 	   AND c.CDGR = 'INQRY_CAT'
		 	   AND c.USE_YN='Y'
		left join MEMBER m
			    ON i.MEM_NO = m.MEM_NO
		where i.INQRY_NO = #{inqryNo}
		  and i.DEL_YN='N'
	</select>

	<!--첨부파일은 inquiry_Mapper.xml과 동일함  -->

	<!-- 첨부파일 목록 조회  -->
	<select id="aAttachFileList" parameterType="int" resultType="map">
		select
			afd.FILE_NO
			,afd.FILE_ORIGINAL_NAME
			,afd.FILE_EXT
			,afd.FILE_SIZE
			,afd.FILE_PATH
		from INQUIRY i
		inner join ATTACH_FILE_DETAIL afd on i.ATTACH_NO = afd.ATTACH_NO
		where i.INQRY_NO = #{inqryNo}
		  and afd.USE_YN = 'Y'
		order by afd.REG_DT
	</select>

	<!-- 첨부파일 단건 조회 (다운로드용) -->
	<select id="selectAttachFile" parameterType="int" resultType="map">
		select
			FILE_NO
			,FILE_ORIGINAL_NAME
			,FILE_PATH
		from ATTACH_FILE_DETAIL
		where FILE_NO=#{fileNo}
		and USE_YN='Y'
	</select>

	<!-- 1:1문의 삭제  -->
	<update id="inquiryDelete" parameterType="int">
		update INQUIRY
		   set DEL_YN='Y'
		   	   ,DEL_DT = SYSDATE
		 where INQRY_NO = #{inqryNo}
	</update>

	<!--문의 답변 등록 -->
	<update id="aInquiryReply" parameterType="kr.or.ddit.mohaeng.vo.InquiryVO">
		update INQUIRY
		   set
	     	REPLY_CN = #{replyCn}
	        ,REPLY_MEM_NO = #{replyMemNo}
	        ,REPLY_DT = SYSDATE
	        ,INQRY_STATUS = 'answered'
		 where INQRY_NO = #{inqryNo}
	</update>

	<!--문의 답변/삭제 알림 등록 -->
	<insert id="insertAlarm" parameterType="kr.or.ddit.mohaeng.vo.AlarmVO">
		<selectKey keyProperty="alarmNo" resultType="int" order="BEFORE">
			SELECT SEQ_ALARM_NO.NEXTVAL FROM DUAL
		</selectKey>

		insert into ALARM(
			ALARM_NO
			,MEM_NO
			,SENDER
			,ALARM_TYPE
			,ALARM_CONT
			,MOVE_URL
			,READ_YN
			,REG_DT
		)VALUES(
			#{alarmNo}
			,#{memNo}
			,'INQRY_ADMIN'
			,<choose>
				<when test="moveUrl.contains('mypage/inquiry/')"> 'INQRY_REPLY' </when>
				<otherwise> 'INQRY_DELETE' </otherwise>
			 </choose>
			,#{alarmCont}
			,#{moveUrl}
			,'N'
			,SYSDATE
		)
	</insert>

</mapper>