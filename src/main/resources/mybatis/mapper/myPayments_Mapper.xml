<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.mypage.payments.mapper.IMyPaymentsMapper">

    <select id="selectPaymentStats" parameterType="int" resultType="map">
	    SELECT 
	        COUNT(*) AS TOTAL_COUNT,
	        COUNT(CASE WHEN PAY_STATUS != 'CANCEL' AND 
	            NVL((SELECT MIN(RESV_DT) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO),
	                (SELECT MIN(FP.DEP_TIME) FROM FLIGHT_RESERVATION FR JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID WHERE FR.PAY_NO = P.PAY_NO)
	            ) <![CDATA[ < ]]> TRUNC(SYSDATE) THEN 1 END) AS COMPLETED_COUNT,
	        COUNT(CASE WHEN PAY_STATUS != 'CANCEL' AND 
	            NVL((SELECT MIN(RESV_DT) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO),
	                (SELECT MIN(FP.DEP_TIME) FROM FLIGHT_RESERVATION FR JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID WHERE FR.PAY_NO = P.PAY_NO)
	            ) >= TRUNC(SYSDATE) THEN 1 END) AS PENDING_COUNT,
	        NVL(SUM(PAY_TOTAL_AMT), 0) AS TOTAL_REVENUE
	    FROM PAYMENT P
	    WHERE MEM_NO = #{memNo}
	</select>

    <select id="selectMyPaymentsCount" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="int">
	    SELECT COUNT(*) 
	    FROM PAYMENT P
	    WHERE MEM_NO = #{memNo}
	    <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(searchType) and searchType != 'all'">
	        AND (
	            CASE 
	                WHEN P.PAY_STATUS = 'CANCEL' THEN 'cancelled'
	                WHEN (
	                    NVL(
	                        (SELECT MIN(RESV_DT) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO),
	                        (SELECT MIN(FP.DEP_TIME) FROM FLIGHT_RESERVATION FR JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID WHERE FR.PAY_NO = P.PAY_NO)
	                    )
	                ) <![CDATA[ < ]]> TRUNC(SYSDATE) THEN 'completed'
	                ELSE 'pending'
	            END
	        ) = #{searchType}
	    </if>
	</select>

    <select id="selectMyPaymentsList" parameterType="kr.or.ddit.mohaeng.vo.PaginationInfoVO" resultType="kr.or.ddit.mohaeng.vo.MyPaymentsVO">
	    SELECT B.* FROM (
	        SELECT A.*, ROWNUM RNUM FROM (
	            SELECT 
	                P.PAY_NO, 
	                P.PAY_DT, 
	                /* PAY_STATUS 동적 판별 로직 추가 */
                CASE 
                    WHEN P.PAY_STATUS = 'CANCEL' THEN 'CANCEL' /* 이미 취소된 건은 유지 */
                    WHEN (
                        NVL(
                            (SELECT MIN(RESV_DT) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO),
                            (SELECT MIN(FP.DEP_TIME) FROM FLIGHT_RESERVATION FR JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID WHERE FR.PAY_NO = P.PAY_NO)
                        )
                    <![CDATA[    
                    ) < TRUNC(SYSDATE) THEN 'DONE' /* 이용일이 오늘보다 이전이면 이용완료 */
                    ]]>
                    ELSE 'WAIT' /* 그 외(오늘 포함 미래)는 이용예정 */
                END AS PAY_STATUS,
	                P.PAY_TOTAL_AMT, 
	                P.USE_POINT, 
	                PI.TID,
	                /* 1. RES_MSG에서 'DONE '을 제거하여 통합 상품명 추출 */
	                REPLACE(PI.RES_MSG, 'DONE ', '') AS PROD_NAME,
	                
	                /* 2. 결제일시와 결제번호를 조합한 번호 (React formatPayNo와 동일 로직) */
	                TO_CHAR(P.PAY_DT, 'YYYYMMDD') || LPAD(P.PAY_NO, 8, '0') AS ORDER_NO,
	                
	                /* 3. 이용 날짜 정보 추출 */
	                NVL(
	                    (SELECT TO_CHAR(MIN(RESV_DT), 'YYYY.MM.DD') || DECODE(MIN(USE_TIME), NULL, '', ' (' || MIN(USE_TIME) || ')') FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO),
	                    (SELECT TO_CHAR(MIN(FP.DEP_TIME), 'YYYY.MM.DD (HH24:MI)') FROM FLIGHT_RESERVATION FR JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID WHERE FR.PAY_NO = P.PAY_NO)
	                ) AS USE_DATE,
	                
	                /* 4. 옵션/인원 정보 */
	                NVL(
	                    (SELECT CASE WHEN COUNT(*) > 1 THEN COUNT(*) || '건' WHEN MAX(TP_U.PROD_CTGRY_TYPE) = 'ACCOMMODATION' THEN SUM(TPL_U.QUANTITY) || '박' ELSE SUM(TPL_U.QUANTITY) || '명' END 
	                     FROM TRIP_PROD_LIST TPL_U JOIN TRIP_PROD TP_U ON TPL_U.TRIP_PROD_NO = TP_U.TRIP_PROD_NO WHERE TPL_U.PAY_NO = P.PAY_NO),
	                    (SELECT COUNT(FPS.PASSENGER_ID) || '명' FROM FLIGHT_RESERVATION FR_S JOIN FLIGHT_PASSENGERS FPS ON FR_S.RESERVE_NO = FPS.RESERVE_NO WHERE FR_S.PAY_NO = P.PAY_NO)
	                ) AS OPTION_INFO,
	
	                /* selectMyPaymentsList 쿼리의 썸네일 부분 */
					NVL(
					    (SELECT AFD.FILE_PATH 
					     FROM ATTACH_FILE_DETAIL AFD 
					     JOIN TRIP_PROD TP_I ON TP_I.ATTACH_NO = AFD.ATTACH_NO 
					     JOIN TRIP_PROD_LIST TPL_I ON TPL_I.TRIP_PROD_NO = TP_I.TRIP_PROD_NO 
					     WHERE TPL_I.PAY_NO = P.PAY_NO 
					       AND AFD.USE_YN = 'Y' 
					       AND ROWNUM = 1),
					    '/resources/images/default_flight.jpg' 
					) AS THUMB_IMG
	            FROM PAYMENT P
	            JOIN PAYMENT_INFO PI ON P.PAY_NO = PI.PAY_NO
	            WHERE P.MEM_NO = #{memNo}
	            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(searchType) and searchType != 'all'">
                /* 검색 필터에서도 동일한 로직이 적용되도록 하려면 아래와 같이 처리 */
                AND (
                    CASE 
                        WHEN P.PAY_STATUS = 'CANCEL' THEN 'cancelled'
                        WHEN (
                            NVL(
                                (SELECT MIN(RESV_DT) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO),
                                (SELECT MIN(FP.DEP_TIME) FROM FLIGHT_RESERVATION FR JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID WHERE FR.PAY_NO = P.PAY_NO)
                            )
	                        <![CDATA[    
                        ) < TRUNC(SYSDATE) THEN 'completed'
                        ]]>
                        ELSE 'pending'
	                END
	                ) = #{searchType}
	            </if>
	            ORDER BY P.PAY_DT DESC
	        ) A
	    ) B
	    WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<select id="selectReceiptDetailList" parameterType="int" resultType="map">
	    /* 1. 숙소/투어 상품 상세 */
	    SELECT 
	        TPL.TRIP_PROD_NO,
	        TP.TRIP_PROD_TITLE AS PROD_NAME,
	        TPL.QUANTITY,
	        TPL.PAY_PRICE AS ITEM_TOTAL_PRICE,
	        TO_CHAR(TPL.RESV_DT, 'YYYY.MM.DD') || ' (' || TPL.USE_TIME || ')' AS USE_INFO,
	        CASE 
	            WHEN (SELECT PAY_STATUS FROM PAYMENT WHERE PAY_NO = TPL.PAY_NO) = 'CANCEL' THEN 'CANCEL'
	            WHEN TPL.RESV_DT <![CDATA[ < ]]> TRUNC(SYSDATE) THEN 'DONE'
	            ELSE 'WAIT'
	        END AS PAY_STATUS,
	        R.PROD_RV_NO,
	        R.PROD_REVIEW,
	        R.RATING,
	        R.RCMDTN_YN,
	        /* 상품 썸네일 */
	        NVL((SELECT AFD.FILE_PATH FROM ATTACH_FILE_DETAIL AFD 
	             WHERE AFD.ATTACH_NO = TP.ATTACH_NO AND AFD.USE_YN = 'Y' AND ROWNUM = 1), 
	            '/resources/images/no_image.jpg') AS THUMB_IMG,
	        /* 리뷰 이미지 경로들 (LISTAGG 활용하여 경로만 콤마로 연결) */
	        (SELECT LISTAGG(AFD.FILE_PATH, ',') WITHIN GROUP (ORDER BY AFD.FILE_NO)
	         FROM ATTACH_FILE_DETAIL AFD 
	         WHERE AFD.ATTACH_NO = R.ATTACH_NO AND AFD.USE_YN = 'Y') AS EXISTING_IMAGES
	    FROM TRIP_PROD_LIST TPL
	    JOIN TRIP_PROD TP ON TPL.TRIP_PROD_NO = TP.TRIP_PROD_NO
	    LEFT OUTER JOIN PROD_REVIEW R ON TPL.TRIP_PROD_NO = R.TRIP_PROD_NO 
	        AND R.MEM_NO = (SELECT MEM_NO FROM PAYMENT WHERE PAY_NO = TPL.PAY_NO)
	        AND R.PROD_REGDATE >= (SELECT PAY_DT FROM PAYMENT WHERE PAY_NO = TPL.PAY_NO)
	    WHERE TPL.PAY_NO = #{payNo}
	
	    UNION ALL
	
	    /* 2. 항공권 상품 상세 */
	    SELECT 
	        NULL AS TRIP_PROD_NO,
	        FP.FLIGHT_SYMBOL || ' 항공권' AS PROD_NAME,
	        (SELECT COUNT(*) FROM FLIGHT_PASSENGERS FPS WHERE FPS.RESERVE_NO = FR.RESERVE_NO) AS QUANTITY,
	        ((P.PAY_TOTAL_AMT + NVL(P.USE_POINT, 0)) / 
	            (SELECT COUNT(*) FROM FLIGHT_PASSENGERS FPS_ALL 
	             JOIN FLIGHT_RESERVATION FR_ALL ON FPS_ALL.RESERVE_NO = FR_ALL.RESERVE_NO 
	             WHERE FR_ALL.PAY_NO = P.PAY_NO)) 
	        * (SELECT COUNT(*) FROM FLIGHT_PASSENGERS FPS_SUB WHERE FPS_SUB.RESERVE_NO = FR.RESERVE_NO) AS ITEM_TOTAL_PRICE,
	        TO_CHAR(FP.DEP_TIME, 'YYYY.MM.DD (HH24:MI)') AS USE_INFO,
	        CASE 
	            WHEN P.PAY_STATUS = 'CANCEL' THEN 'CANCEL'
	            WHEN FP.DEP_TIME <![CDATA[ < ]]> SYSDATE THEN 'DONE'
	            ELSE 'WAIT'
	        END AS PAY_STATUS,
	        NULL AS PROD_RV_NO,
	        NULL AS PROD_REVIEW,
	        NULL AS RATING,
	        NULL AS RCMDTN_YN,
	        '/resources/images/default_flight.jpg' AS THUMB_IMG,
	        NULL AS EXISTING_IMAGES
	    FROM FLIGHT_RESERVATION FR
	    JOIN FLIGHT_PRODUCT FP ON FR.FLT_PROD_ID = FP.FLT_PROD_ID
	    JOIN PAYMENT P ON FR.PAY_NO = P.PAY_NO
	    WHERE FR.PAY_NO = #{payNo}
	</select>
		
	<select id="selectPaymentMaster" parameterType="int" resultType="map">
	    SELECT 
	        P.PAY_NO,
	        TO_CHAR(P.PAY_DT, 'YYYY.MM.DD HH24:MI:SS') AS PAY_DT,
	        P.PAY_TOTAL_AMT,
	        P.USE_POINT,
	        P.PAY_STATUS,
	        P.PAY_METHOD_CD,
	        /* 1. 결제번호 조합: YYYYMMDD + 00000152 (8자리 패딩) */
	        TO_CHAR(P.PAY_DT, 'YYYYMMDD') || LPAD(P.PAY_NO, 8, '0') AS ORDER_NO,
	        
	        /* 2. TID 및 가공된 상품명 (RES_MSG 활용) */
	        PI.TID AS TID,
	        REPLACE(PI.RES_MSG, 'DONE ', '') AS PROD_NAME,
	        
	        /* 3. 결제자 정보: MEMBER(이름, 이메일) + MEM_USER(연락처) */
	        M.MEM_NAME,
	        M.MEM_EMAIL,
	        MU.TEL AS MEM_TEL,  /* 4. 판매자 정보 */
	        C.BZMN_NM, 
	        C.BRNO,    
	        C.COMP_TEL AS COMP_TEL, 
	        
	        /* 5. 금액 계산 로직 */
	        CASE 
	            WHEN EXISTS (SELECT 1 FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO) THEN 
	                (SELECT SUM(UNIT_PRICE * QUANTITY) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO)
	            ELSE (P.PAY_TOTAL_AMT + P.USE_POINT) 
	        END AS PROD_TOTAL_PRICE, 
	        
	        /* 6. 할인 로직 */
	        CASE 
	            WHEN EXISTS (SELECT 1 FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO) THEN 
	                (SELECT SUM(NVL(DISCOUNT_AMT, 0)) FROM TRIP_PROD_LIST WHERE PAY_NO = P.PAY_NO)
	            ELSE 0 
	        END AS TOTAL_DISCOUNT 
	        
	    FROM PAYMENT P
	    JOIN PAYMENT_INFO PI ON P.PAY_NO = PI.PAY_NO
	    JOIN MEMBER M ON P.MEM_NO = M.MEM_NO
	    LEFT OUTER JOIN MEM_USER MU ON M.MEM_NO = MU.MEM_NO  /* 판매자 정보를 찾기 위한 조인 로직 */
	    LEFT OUTER JOIN (
	        SELECT PAY_NO, TRIP_PROD_NO, ROW_NUMBER() OVER(PARTITION BY PAY_NO ORDER BY PROD_LIST_NO) AS RN 
	        FROM TRIP_PROD_LIST
	    ) TPL ON P.PAY_NO = TPL.PAY_NO AND TPL.RN = 1
	    LEFT OUTER JOIN TRIP_PROD TP ON TPL.TRIP_PROD_NO = TP.TRIP_PROD_NO
	    LEFT OUTER JOIN COMPANY C ON TP.COMP_NO = C.COMP_NO
	    
	    WHERE P.PAY_NO = #{payNo}
	</select>
	
	<update id="updateFileUseN" parameterType="string">
	    UPDATE ATTACH_FILE_DETAIL
	    SET USE_YN = 'N'
	    WHERE FILE_PATH = #{filePath}
	</update>
	
	<insert id="insertAdditionalFileDetail" parameterType="map">
	    INSERT INTO ATTACH_FILE_DETAIL (
	        FILE_NO, 
	        ATTACH_NO, /* 기존에 리뷰가 가지고 있던 ATTACH_NO 전달 */
	        FILE_NAME, 
	        FILE_ORIGINAL_NAME, 
	        FILE_EXT, 
	        FILE_SIZE, 
	        FILE_PATH, 
	        FILE_GB_CD, 
	        MIMY_TYPE, 
	        USE_YN, 
	        REG_ID, 
	        REG_DT
	    ) VALUES (
	        SEQ_ATTACH_FILE_DETAIL.NEXTVAL,
	        #{attachNo}, 
	        #{fileName}, 
	        #{originalName}, 
	        #{ext}, 
	        #{size}, 
	        #{path}, 
	        'REVIEW', 
	        #{mimeType}, 
	        'Y', 
	        #{regId}, 
	        SYSDATE
	    )
	</insert>

	<select id="nextAttachNo" resultType="long">
	    SELECT SEQ_ATTACH_FILE.NEXTVAL FROM DUAL
	</select>
	
	<select id="nextFileNo" resultType="long">
	    SELECT SEQ_ATTACH_FILE_DETAIL.NEXTVAL FROM DUAL
	</select>
	
	<insert id="insertAttachFile" parameterType="map">
	    INSERT INTO ATTACH_FILE (ATTACH_NO, REG_ID, REG_DT)
	    VALUES (#{attachNo}, #{regId}, TO_CHAR(SYSDATE, 'YYYY/MM/DD'))
	</insert>
	
	<insert id="insertAttachFileDetail" parameterType="map">
	    INSERT INTO ATTACH_FILE_DETAIL (
	        FILE_NO, ATTACH_NO, FILE_NAME, FILE_ORIGINAL_NAME, 
	        FILE_EXT, FILE_SIZE, FILE_PATH, FILE_GB_CD, 
	        MIMY_TYPE, USE_YN, REG_ID, REG_DT
	    ) VALUES (
	        #{fileNo}, #{attachNo}, #{fileName}, #{originalName}, 
	        #{ext}, #{size}, #{path}, 'REVIEW', 
	        #{mimeType}, 'Y', #{regId}, SYSDATE
	    )
	</insert>

</mapper>