<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.payment.mapper.IPaymentMapper">
	
	<!--  결제  -->
	<insert id="insertPayment" parameterType="kr.or.ddit.mohaeng.vo.PaymentVO" useGeneratedKeys="true">
		<selectKey keyProperty="payNo" resultType="int" order="BEFORE">
			select seq_payment.nextval from dual
		</selectKey>
		INSERT INTO payment (
		    pay_no, mem_no, pay_total_amt, use_point, pay_method_cd
		    , pay_dt, pay_status, payment_key
		) VALUES (
			#{payNo}, #{memNo}, #{payTotalAmt}, #{usePoint}, #{payMethodCd}
			, #{payDt}, #{payStatus}, #{paymentKey}
		)
	</insert>

	<!-- 결제 상세 정보 -->
	<insert id="insertPaymentInfo" parameterType="kr.or.ddit.mohaeng.vo.PaymentInfoVO">
		INSERT INTO payment_info (
	        pay_no, tid, pay_method_type
	        , card_corp_code, auth_no, vbank_num
	        , vbank_exp_dt,  res_code, res_msg
	        , pay_raw_data
	    ) VALUES (
	        #{payNo}, #{tid}, #{payMethodType}
	        , #{cardCorpCode}, #{authNo}, #{vbankNum}
	        , #{vbankExpDt}, #{resCode}
	        , #{resMsg}, #{payRawData, jdbcType=CLOB}
	    )
	</insert>
	
	<!-- 포인트 적립 -->
	<update id="insertPoint" parameterType="kr.or.ddit.mohaeng.vo.MemberVO">
		UPDATE member
			SET
			    point = point + #{point}
			WHERE
		        mem_no = #{memNo}
	</update>
	
	<!-- 포인트 사용 -->
	<update id="updatePoint" parameterType="kr.or.ddit.mohaeng.vo.MemberVO">
		UPDATE member
			SET
			    point = point - #{point}
			WHERE
		        mem_no = #{memNo}
	</update>
	
	<!-- 투어 상품 목록 저장 -->
	<insert id="insertTripProdList" parameterType="kr.or.ddit.mohaeng.vo.TripProdListVO">
	    <selectKey keyProperty="prodListNo" resultType="int" order="BEFORE">
	        SELECT SEQ_TRIP_PROD_LIST.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO TRIP_PROD_LIST (
	        PROD_LIST_NO, PAY_NO, TRIP_PROD_NO,
	        UNIT_PRICE, DISCOUNT_AMT, PAY_PRICE, QUANTITY,
	        RESV_DT, USE_TIME, RSV_MEMO
	    ) VALUES (
	        #{prodListNo}, #{payNo}, #{tripProdNo},
	        #{unitPrice}, #{discountAmt}, #{payPrice}, #{quantity},
	        TO_DATE(#{resvDt}, 'YYYY-MM-DD'), #{useTime}, #{rsvMemo}
	    )
	</insert>

	<!-- 마케팅 동의 업데이트 -->
	<update id="updateMktAgree" parameterType="int">
		UPDATE MEMBER_TERMS_AGREE
		SET MARKETING_YN = 'Y',
			UDT_DT = SYSDATE
		WHERE MEM_NO = #{memNo}
		  AND MARKETING_YN = 'N'
	</update>
	
	<!-- 투어상품 재고 감소 -->
	<update id="decreaseStock">
	    UPDATE TRIP_PROD_SALE
	    SET CUR_STOCK = CUR_STOCK - #{quantity}
	    WHERE TRIP_PROD_NO = #{tripProdNo}
	    AND CUR_STOCK >= #{quantity}
	</update>
	
	<!-- 현재 재고 조회 -->
	<select id="getCurrentStock" resultType="int">
	    SELECT CUR_STOCK 
	    FROM TRIP_PROD_SALE 
	    WHERE TRIP_PROD_NO = #{tripProdNo}
	</select>
	
	<!-- 판매중지 처리 -->
	<update id="updateSoldOut">
	    UPDATE TRIP_PROD
	    SET APPROVE_STATUS = '판매중지'
	    WHERE TRIP_PROD_NO = #{tripProdNo}
	</update>
	
	<!-- 매출 저장 -->
	<insert id="insertSales" parameterType="kr.or.ddit.mohaeng.vo.SalesVO">
	    <selectKey keyProperty="saleNo" resultType="int" order="BEFORE">
	        SELECT SEQ_SALES.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO SALES (
	        SALE_NO, PROD_LIST_NO, SALE_DT, NET_SALES, SETTLE_STAT_CD
	    ) VALUES (
	        #{saleNo}, #{prodListNo}, SYSDATE, #{netSales}, '정산대기'
	    )
	</insert>
	
</mapper>