<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.mypage.point.mapper.IPointMapper">

	<!-- ==================== 조회 기능 ==================== -->

	 <!-- 회원별 포인트 요약 정보 조회 (WITH 절 + 날짜 범위 비교로 성능 개선)-->
	 <select id="pointSummary" parameterType="int" resultType="kr.or.ddit.mohaeng.vo.PointSummaryVO">
	 	<!--바구니 만들기-->
	 	WITH PointStats AS(
 			SELECT
	 			MEM_NO
	 			<!-- 이번 달 적립 포인트 -->
                ,SUM(CASE
                    WHEN POINT_TYPE = 'P'
                     AND REG_DT >= TRUNC(SYSDATE, 'MM')
                     AND REG_DT <![CDATA[<]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
                    THEN POINT_AMT
                    ELSE 0
                END) AS earnedThisMonth

                <!-- 이번 달 사용 포인트 -->
                ,SUM(CASE
                    WHEN POINT_TYPE = 'M'
                     AND POINT_TARGET = 'PAYMENT'
                     AND REG_DT >= TRUNC(SYSDATE, 'MM')
                     AND REG_DT <![CDATA[<]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
                    THEN ABS(POINT_AMT)
                    ELSE 0
                END) AS usedThisMonth

                <!-- 이번 달 소멸 예정 포인트 -->
                ,SUM(CASE
                    WHEN POINT_TYPE = 'P'
                     AND REMAIN_POINT > 0
                     AND PNT_EXPIRE_DT >= TRUNC(SYSDATE, 'MM')
                     AND PNT_EXPIRE_DT <![CDATA[<]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
                    THEN REMAIN_POINT
                    ELSE 0
                END) AS expireSoonPoint

                <!-- 누적 적립 포인트 -->
                ,SUM(CASE
                    WHEN POINT_TYPE = 'P'
                    THEN POINT_AMT
                    ELSE 0
                END) AS totalEarned

                <!-- 누적 사용 포인트 -->
                ,SUM(CASE
                    WHEN POINT_TYPE = 'M'
                     AND POINT_TARGET = 'PAYMENT'
                    THEN ABS(POINT_AMT)
                    ELSE 0
                END) AS totalUsed
	       FROM POINT_DETAILS
	       WHERE MEM_NO = #{memNo}
	       GROUP BY MEM_NO
	 	)
	 	<!--화면에 보낼 데이터 뽑기-->
	 	SELECT
	 		m.MEM_NO
	 		, m.MEM_NAME
	 		, m.MEM_EMAIL
	 		, NVL(m.POINT, 0) AS totalPoints
	 		, NVL(ps.earnedThisMonth, 0) AS earnedThisMonth
	 		, NVL(ps.usedThisMonth, 0) AS usedThisMonth
	 		, NVL(ps.expireSoonPoint, 0) AS expireSoonPoint
	 		, NVL(ps.totalEarned, 0) AS totalEarned
	 		, NVL(ps.totalUsed, 0) AS totalUsed
	 	FROM MEMBER m
	 	LEFT JOIN PointStats ps
	 	  ON m.MEM_NO = ps.MEM_NO
	 	WHERE m.MEM_NO = #{memNo}
	 </select>

	 <!-- 포인트 내역 전체 개수 -->
	<select id="pointHistoryCount" parameterType="kr.or.ddit.mohaeng.vo.PointSearchVO" resultType="int">
		SELECT COUNT(*)
		FROM POINT_DETAILS
		WHERE MEM_NO = #{memNo}

		<if test="pointType != null and pointType !=''">
			AND POINT_TYPE = #{pointType}
		</if>
		<if test="pointTarget != null and pointTarget !=''">
			AND POINT_TARGET = #{pointTarget}
		</if>
		<if test="period != null and period !=''">
			<choose>
				<when test="period == '3month'">
					AND REG_DT >= ADD_MONTHS(TRUNC(SYSDATE), -3)
				</when>
				<when test="period == '6month'">
					AND REG_DT >= ADD_MONTHS(TRUNC(SYSDATE), -6)
				</when>
				<when test="period == '1year'">
					AND REG_DT >= ADD_MONTHS(TRUNC(SYSDATE), -12)
				</when>
			</choose>
		</if>
	</select>

	 <!-- 포인트 내역 목록 조회 (페이징) : 내가 보고 싶은 페이지만 잘라서 가져옴 -->
	<select id="pointHistory" parameterType="kr.or.ddit.mohaeng.vo.PointSearchVO" resultType="kr.or.ddit.mohaeng.vo.PointDetailsVO">
		SELECT *
		FROM (
			SELECT ROWNUM rnum, A.*
			FROM (
				SELECT
					pd.POINT_DETAILS_NO
					, pd.MEM_NO
					, pd.POINT_POL_NO
					, pd.POINT_TYPE
					, pd.POINT_AMT
					, pd.POINT_DESC
					, pd.POINT_TARGET
					, pd.POINT_TARGET_ID
					, pd.REMAIN_POINT
					, pd.PNT_EXPIRE_DT
					, pd.REG_DT
					, m.MEM_NAME
					, m.MEM_EMAIL
					, m.POINT AS currentBalance
					, SUM(pd.POINT_AMT) OVER (PARTITION BY pd.MEM_NO ORDER BY pd.REG_DT, pd.POINT_DETAILS_NO) AS balanceAfter
				FROM POINT_DETAILS pd
				JOIN MEMBER m ON pd.MEM_NO = m.MEM_NO
				WHERE pd.MEM_NO = #{memNo}
				<if test="pointType != null and pointType !=''">
					AND pd.POINT_TYPE = #{pointType}
				</if>
				<if test="pointTarget != null and pointTarget !=''">
					AND pd.POINT_TARGET = #{pointTarget}
				</if>
				<if test="period != null and period !=''">
					<choose>
						<when test="period == '3month'">
							AND pd.REG_DT >= ADD_MONTHS(TRUNC(SYSDATE), -3)
						</when>
						<when test="period == '6month'">
							AND pd.REG_DT >= ADD_MONTHS(TRUNC(SYSDATE), -6)
						</when>
						<when test="period == '1year'">
							AND pd.REG_DT >= ADD_MONTHS(TRUNC(SYSDATE), -12)
						</when>
					</choose>
				</if>
				<!-- 날짜 범위 검색 조건  -->
				<if test="startDate != null and startDate != ''">
					AND pd.REG_DT >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
				</if>
				<if test="endDate != null and endDate != ''">
					AND pd.REG_DT <![CDATA[<]]> TO_DATE(#{endDate},'YYYY-MM-DD')+1
				</if>
				ORDER BY pd.REG_DT DESC, pd.POINT_DETAILS_NO DESC
			)A
		)
		WHERE rnum BETWEEN #{paginationVO.startRow} and #{paginationVO.endRow}
	</select>



	 <!-- ==================== 포인트 정책 실행 ==================== -->

	 <!-- 중복 적립 방지 체크 : 이미 받아갔는지 체크!-->
	<select id="checkDuplEarn" resultType="int">
		SELECT COUNT(*)
		FROM POINT_DETAILS
		WHERE MEM_NO = #{memNo}
			AND POINT_TARGET = #{target}
			AND POINT_TARGET_ID = #{targetId}
			AND POINT_TYPE = 'P'
	</select>

	 <!-- 포인트 상세 내역 등록 : 새 영수증 만들기-->
	 <insert id="insertPointDetails" parameterType="kr.or.ddit.mohaeng.vo.PointDetailsVO">
	 	<selectKey keyProperty="pointDetailsNo" resultType="int" order="BEFORE">
	 		SELECT SEQ_POINT_DETAILS.NEXTVAL FROM DUAL
	 	</selectKey>
	 	INSERT INTO POINT_DETAILS(
	 		POINT_DETAILS_NO
	 		, MEM_NO
	 		, POINT_TYPE
	 		, POINT_AMT
	 		, POINT_DESC
	 		, POINT_TARGET
	 		, POINT_TARGET_ID
	 		, REMAIN_POINT
	 		, PNT_EXPIRE_DT
	 		, REG_DT
	 	)VALUES(
	 		#{pointDetailsNo}
	 		, #{memNo}
	 		, #{pointType}
	 		, #{pointAmt}
	 		, #{pointDesc}
	 		, #{pointTarget}
	 		, #{pointTargetId}
	 		, #{remainPoint}
	 		, <choose>
	 			<when test="pntExpireDt !=null">#{pntExpireDt}</when>
	 			<when test='pointType == "P"'>SYSDATE +180</when>
	 			<otherwise>NULL</otherwise>
	 		  </choose>
	 		, SYSDATE
	 	)
	 </insert>

	 <!-- MEMBER 테이블의 POINT 컬럼 업데이트 -->
	<update id="updateMemberPoint">
		UPDATE MEMBER
		SET POINT = POINT + #{amount}
		WHERE MEM_NO = #{memNo}
	</update>

	 <!-- 회원의 현재 보유 포인트 조회 : 지갑확인 -->
	 <select id="selectMemberPoint" parameterType="int" resultType="int">
	 	SELECT NVL(POINT, 0)
	 	FROM MEMBER
	 	WHERE MEM_NO = #{memNo}
	 </select>

	 <!-- 사용 가능한 포인트 목록 조회 (만료일 임박 순) -->
	 <select id="availablePoints" parameterType="int" resultType="kr.or.ddit.mohaeng.vo.PointDetailsVO">
	 	SELECT
	 		POINT_DETAILS_NO
            , MEM_NO
            , POINT_TYPE
            , POINT_AMT
            , REMAIN_POINT
            , PNT_EXPIRE_DT
        FROM POINT_DETAILS
        WHERE MEM_NO = #{memNo}
          AND POINT_TYPE = 'P'
          AND REMAIN_POINT > 0
          AND (PNT_EXPIRE_DT IS NULL OR PNT_EXPIRE_DT > SYSDATE)
        ORDER BY PNT_EXPIRE_DT ASC NULLS LAST
	 </select>

	 <!-- 포인트 상세 내역의 잔여 포인트 차감 -->
	<update id="deductRemainPoint">
		UPDATE POINT_DETAILS
		SET REMAIN_POINT = REMAIN_POINT - #{deductAmount}
		WHERE POINT_DETAILS_NO = #{pointDetailsNo}
	</update>

	 <!-- 결제 시 사용한 포인트 조회 : 과거 영수증 뒤져보기 -->
	 <select id="usedPoint" resultType="kr.or.ddit.mohaeng.vo.PointDetailsVO">
	 	SELECT
	 		POINT_DETAILS_NO
	 		, MEM_NO
	 		, POINT_TYPE
	 		, POINT_AMT
	 		, POINT_TARGET
	 		, POINT_TARGET_ID
	 		, REG_DT
	 	FROM POINT_DETAILS
	 	WHERE MEM_NO = #{memNo}
	 	  AND POINT_TARGET = 'PAYMENT'
	 	  AND POINT_TARGET_ID = #{payNo}
	 	  AND POINT_TYPE = 'M'
	 </select>

	 <!-- 환불을 위한 원래 포인트 목록 조회 (FIFO) : 언제 적립된건지 적립내역들을 찾아내는것-->
	<select id="originPointsForRefund" resultType="kr.or.ddit.mohaeng.vo.PointDetailsVO">
		SELECT
			POINT_DETAILS_NO
			, MEM_NO
			, REMAIN_POINT
			, PNT_EXPIRE_DT
		FROM POINT_DETAILS
		WHERE MEM_NO = #{memNo}
			AND POINT_TYPE = 'P'
			AND REG_DT <![CDATA[<=]]> #{usedDate}
		ORDER BY PNT_EXPIRE_DT ASC NULLS LAST
	</select>

	 <!-- 결제로 적립된 포인트 조회 : 과거 영수증 뒤져보기 -->
	<select id="earnPoint" resultType="kr.or.ddit.mohaeng.vo.PointDetailsVO">
		SELECT
			POINT_DETAILS_NO
			, MEM_NO
			, POINT_TYPE
			, POINT_AMT
			, POINT_TARGET
			, POINT_TARGET_ID
		FROM POINT_DETAILS
		WHERE MEM_NO = #{memNo}
			AND POINT_TARGET = 'PAYMENT'
			AND POINT_TARGET_ID = #{payNo}
			AND POINT_TYPE = 'P'
	</select>

	 <!-- 회원의 현재 포인트 조회 : 최종잔액만 딱! 읽어오기 위한 것 -->
	 <select id="memberPoint" parameterType="int" resultType="int">
	 	SELECT NVL(POINT, 0)
	 	FROM MEMBER
	 	WHERE MEM_NO = #{memNo}
	 </select>

</mapper>