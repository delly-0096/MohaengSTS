<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.product.review.mapper.IProdReviewMapper">

    <!-- 리뷰 ResultMap -->
    <resultMap id="reviewResultMap" type="kr.or.ddit.mohaeng.product.review.vo.ProdReviewVO">
        <id property="prodRvNo" column="PROD_RV_NO"/>
        <result property="tripProdNo" column="TRIP_PROD_NO"/>
        <result property="memNo" column="MEM_NO"/>
        <result property="prodReview" column="PROD_REVIEW"/>
        <result property="prodRegdate" column="PROD_REGDATE"/>
        <result property="prodUdtdate" column="PROD_UDTDATE"/>
        <result property="rating" column="RATING"/>
        <result property="attachNo" column="ATTACH_NO"/>
        <result property="rcmdtnYn" column="RCMDTN_YN"/>
		<result property="reviewStatus" column="REVIEW_STATUS"/>
        <result property="nickname" column="NICKNAME"/>
        <result property="profileImage" column="PROFILE_IMAGE"/>
        <!--신고용 추가-->
        <result property="reviewStatus" column="REVIEW_STATUS"/>

        <!-- 리뷰 이미지 목록 (1:N) -->
        <collection property="reviewImages" column="ATTACH_NO"
                    select="selectReviewImages" ofType="string"/>
    </resultMap>

    <!-- 리뷰 이미지 조회 -->
    <select id="selectReviewImages" parameterType="int" resultType="string">
        SELECT FILE_PATH
        FROM ATTACH_FILE_DETAIL
        WHERE ATTACH_NO = #{attachNo}
          AND USE_YN = 'Y'
        ORDER BY FILE_NO
    </select>

    <!-- 리뷰의 ATTACH_NO 조회 -->
    <select id="getReviewAttachNo" parameterType="int" resultType="Integer">
        SELECT ATTACH_NO FROM PROD_REVIEW WHERE PROD_RV_NO = #{prodRvNo}
    </select>

    <!-- 리뷰에 ATTACH_NO 연결 -->
    <update id="updateReviewAttachNo">
        UPDATE PROD_REVIEW
        SET ATTACH_NO = #{attachNo}
        WHERE PROD_RV_NO = #{prodRvNo}
    </update>

	<!-- 리뷰 목록 (페이징) -->
	<select id="getReviewPaging" parameterType="map" resultMap="reviewResultMap">
	    SELECT * FROM (
	        SELECT ROWNUM AS RN, A.* FROM (
	            SELECT
	                r.PROD_RV_NO,
	                r.TRIP_PROD_NO,
	                r.MEM_NO,
	                r.PROD_REVIEW,
	                r.PROD_REGDATE,
	                r.PROD_UDTDATE,
	                r.RATING,
	                r.ATTACH_NO,
	                r.RCMDTN_YN,
                	r.REVIEW_STATUS,
	                u.NICKNAME,
                    pf.FILE_PATH AS PROFILE_IMAGE
	            FROM PROD_REVIEW r
	            LEFT JOIN MEM_USER u ON r.MEM_NO = u.MEM_NO
                LEFT JOIN MEMBER m ON r.MEM_NO = m.MEM_NO
	            LEFT JOIN ATTACH_FILE_DETAIL pf ON m.MEM_PROFILE = pf.ATTACH_NO AND pf.USE_YN = 'Y'
                WHERE r.TRIP_PROD_NO = #{tripProdNo}
	              AND (r.REVIEW_STATUS IS NULL OR r.REVIEW_STATUS != 'HIDDEN')
	            ORDER BY r.PROD_REGDATE DESC
	        ) A
	        <![CDATA[
	        WHERE ROWNUM <= #{endRow}
	        ]]>
	    )
	    <![CDATA[
	    WHERE RN > #{startRow}
	    ]]>
	</select>

    <!-- 리뷰 통계 -->
    <select id="getStat" parameterType="int" resultType="kr.or.ddit.mohaeng.product.review.vo.ProdReviewVO">
        SELECT
            TRIP_PROD_NO,
            ROUND(AVG(RATING), 1) AS AVG_RATING,
            COUNT(*) AS REVIEW_COUNT,
            COUNT(CASE WHEN RCMDTN_YN = 'Y' THEN 1 END) AS RECOMMEND_COUNT
        FROM PROD_REVIEW
        WHERE TRIP_PROD_NO = #{tripProdNo}
       	  AND (REVIEW_STATUS IS NULL OR REVIEW_STATUS != 'HIDDEN')
        GROUP BY TRIP_PROD_NO
    </select>

    <!-- 리뷰 수정 -->
	<update id="updateReview" parameterType="kr.or.ddit.mohaeng.product.review.vo.ProdReviewVO">
	    UPDATE PROD_REVIEW
	    SET PROD_REVIEW = #{prodReview},
	        RATING = #{rating},
	        RCMDTN_YN = #{rcmdtnYn},
	        PROD_UDTDATE = SYSDATE
	    WHERE PROD_RV_NO = #{prodRvNo}
	      AND MEM_NO = #{memNo}
	</update>

	<!-- 리뷰 삭제 -->
	<delete id="deleteReview" parameterType="map">
	    DELETE FROM PROD_REVIEW
	    WHERE PROD_RV_NO = #{prodRvNo}
	      AND MEM_NO = #{memNo}
	</delete>

	<!-- 리뷰 등록 -->
	<insert id="insertReview" parameterType="kr.or.ddit.mohaeng.product.review.vo.ProdReviewVO">
	    <selectKey keyProperty="prodRvNo" resultType="int" order="BEFORE">
	        SELECT SEQ_PROD_REVIEW.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO PROD_REVIEW (
	        PROD_RV_NO, TRIP_PROD_NO, MEM_NO, PROD_REVIEW,
	        PROD_REGDATE, RATING, ATTACH_NO, RCMDTN_YN, REVIEW_STATUS
	    ) VALUES (
	        #{prodRvNo}, #{tripProdNo}, #{memNo}, #{prodReview},
	        SYSDATE, #{rating}, #{attachNo, jdbcType=INTEGER}, #{rcmdtnYn}, 'ACTIVE'
	    )
	</insert>

</mapper>