<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mohaeng.product.review.mapper.IProdReviewMapper">

    <!-- 리뷰 ResultMap -->
    <resultMap id="reviewResultMap" type="kr.or.ddit.mohaeng.product.review.vo.ProdReviewVO">
        <id property="prodRvNo" column="PROD_RV_NO"/>
        <result property="tripProdNo" column="TRIP_PROD_NO"/>
        <result property="memNo" column="MEM_NO"/>
        <result property="prodReview" column="PROD_REVIEW"/>
        <result property="prodRegdate" column="PROD_REGDATE"/>
        <result property="prodUdtdate" column="PROD_UDTDATE"/>
        <result property="rating" column="RATING"/>
        <result property="attachNo" column="ATTACH_NO"/>
        <result property="rcmdtnYn" column="RCMDTN_YN"/>
        <result property="nickname" column="NICKNAME"/>
        
        <!-- 리뷰 이미지 목록 (1:N) -->
        <collection property="reviewImages" column="ATTACH_NO" 
                    select="selectReviewImages" ofType="string"/>
    </resultMap>
    
    <!-- 리뷰 이미지 조회 -->
    <select id="selectReviewImages" parameterType="int" resultType="string">
        SELECT FILE_PATH
        FROM ATTACH_FILE_DETAIL
        WHERE ATTACH_NO = #{attachNo}
          AND USE_YN = 'Y'
        ORDER BY FILE_NO
    </select>

	<!-- 리뷰 목록 (페이징) -->
	<select id="getReviewPaging" parameterType="map" resultMap="reviewResultMap">
	    SELECT * FROM (
	        SELECT ROWNUM AS RN, A.* FROM (
	            SELECT
	                r.PROD_RV_NO,
	                r.TRIP_PROD_NO,
	                r.MEM_NO,
	                r.PROD_REVIEW,
	                r.PROD_REGDATE,
	                r.PROD_UDTDATE,
	                r.RATING,
	                r.ATTACH_NO,
	                r.RCMDTN_YN,
	                u.NICKNAME
	            FROM PROD_REVIEW r
	            LEFT JOIN MEM_USER u ON r.MEM_NO = u.MEM_NO
	            WHERE r.TRIP_PROD_NO = #{tripProdNo}
	            ORDER BY r.PROD_REGDATE DESC
	        ) A
	        <![CDATA[
	        WHERE ROWNUM <= #{endRow}
	        ]]>
	    )
	    <![CDATA[
	    WHERE RN > #{startRow}
	    ]]>
	</select>

    <!-- 리뷰 통계 (단일 상품) -->
    <select id="getStat" parameterType="int" resultType="kr.or.ddit.mohaeng.product.review.vo.ProdReviewVO">
        SELECT
            TRIP_PROD_NO,
            ROUND(AVG(RATING), 1) AS AVG_RATING,
            COUNT(*) AS REVIEW_COUNT,
            COUNT(CASE WHEN RCMDTN_YN = 'Y' THEN 1 END) AS RECOMMEND_COUNT
        FROM PROD_REVIEW
        WHERE TRIP_PROD_NO = #{tripProdNo}
        GROUP BY TRIP_PROD_NO
    </select>

</mapper>